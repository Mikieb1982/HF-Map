<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hoher Fl√§ming POI Explorer</title>
    <!-- Tone.js for audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        /* Basic page styling */
        html, body {
            margin: 0; padding: 0; overflow: hidden;
            height: 100%; width: 100%;
            background-color: #2c2c2c;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            position: relative;
        }

        /* Map Container */
        #map-container {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            overflow: scroll; cursor: grab;
            background-color: #555;
            transition: opacity 0.5s ease-in-out;
            -webkit-overflow-scrolling: touch;
        }
        #map-container:active { cursor: grabbing; }

        /* Inner Map Content */
        #map-content { position: relative; width: 2048px; height: 1448px; }

        /* Map Image */
        #map-image { display: block; width: 100%; height: 100%; opacity: 1; transition: opacity 0.5s; pointer-events: none; }
        #map-image.loading { opacity: 0; }
        #map-image.error { opacity: 0.2; }

        /* Helicopter Container (for helicopter and shadow) */
        #helicopter-container {
            position: absolute;
            width: 60px; height: 60px;
            transform-origin: center top; /* Origin at nose */
            z-index: 10;
            pointer-events: none;
        }

        /* Helicopter Image */
        #helicopter {
            position: absolute;
            width: 100%; height: 100%;
            font-size: 60px; /* Fallback emoji */
            line-height: 60px;
            text-align: center;
            transition: transform 0.05s linear;
        }

        /* Helicopter Shadow */
        #helicopter-shadow {
            position: absolute;
            width: 80%;
            height: 30%;
            background-color: rgba(0,0,0,0.25);
            border-radius: 50%;
            top: 110%; /* Position below the helicopter */
            left: 10%;
            filter: blur(4px);
            z-index: -1;
        }

        /* POI Marker styling */
        .poi-marker {
            position: absolute;
            width: 16px;
            height: 16px;
            background-color: hsla(50, 100%, 60%, 0.8); /* Bright yellow */
            border: 2px solid rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            transform: translate(-50%, -50%); /* Center on coordinate */
            box-shadow: 0 0 10px hsla(50, 100%, 70%, 0.7);
            z-index: 5;
            transition: background-color 0.5s, box-shadow 0.5s;
        }
        .poi-marker.visited {
            background-color: hsla(120, 70%, 50%, 0.8); /* Green */
            box-shadow: 0 0 12px hsla(120, 70%, 60%, 0.8);
        }
        .poi-marker .poi-number {
             position: absolute;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
             color: black;
             font-size: 10px;
             font-weight: bold;
        }


        /* Top Info */
        #info {
            position: fixed; top: 8px; left: 8px;
            background-color: rgba(0, 0, 0, 0.75); color: #fff;
            padding: 6px 10px; border-radius: 4px;
            font-size: 12px; z-index: 30; pointer-events: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        #keyboard-controls { display: none; }
        @media (min-width: 768px) { #keyboard-controls { display: block; } }

        /* Debug Info */
        #debug-info {
            position: fixed; bottom: 150px;
            left: 8px; background-color: rgba(200, 0, 0, 0.8); color: #fff;
            padding: 5px 8px; border-radius: 3px; font-size: 10px;
            z-index: 30; display: none; pointer-events: none;
        }

        /* Land Indicator */
        #land-indicator {
            position: fixed; bottom: 90px;
            left: 50%; transform: translateX(-50%);
            background-color: rgba(255, 193, 7, 0.9); color: #000;
            padding: 6px 12px; border-radius: 4px; font-size: 14px;
            font-weight: bold; z-index: 20; display: none;
            text-align: center; pointer-events: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* Info Panel & Completion Panel */
        .modal-panel {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.9); display: flex;
            justify-content: center; align-items: center;
            opacity: 0; visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0s 0.5s;
            z-index: 40; pointer-events: none;
        }
        .modal-panel.visible { opacity: 1; visibility: visible; transition-delay: 0s; pointer-events: auto; }

        .modal-content {
            background-color: #e0e0e0; color: #333; padding: 25px; border-radius: 6px;
            width: 90%; max-width: 600px; max-height: 85%; overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4); position: relative;
            border: 1px solid #bbb;
        }
        .modal-content h2 { margin-top: 0; color: #111; border-bottom: 1px solid #aaa; padding-bottom: 10px; font-size: 1.3em; }
        .modal-content p { font-size: 1em; line-height: 1.5; }

        .modal-button {
            display: block; margin: 20px auto 0; padding: 12px 25px;
            font-size: 16px; font-weight: bold; color: #fff;
            background: linear-gradient(to bottom, #6c757d, #495057);
            border: 1px solid #888; border-radius: 5px; cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 3px rgba(0,0,0,0.2);
        }
        .modal-button:hover { background: linear-gradient(to bottom, #80888f, #5a6268); }
        .modal-button:active { box-shadow: inset 0 1px 3px rgba(0,0,0,0.3); }

        /* --- Joystick Styling --- */
        #joystick-container {
            position: fixed;
            bottom: 20px; left: 20px; right: auto;
            width: 120px; height: 120px;
            z-index: 35; pointer-events: none;
        }
        #joystick-base {
            position: absolute; width: 100%; height: 100%; border-radius: 50%;
            background: rgba(80, 80, 80, 0.5); border: 2px solid rgba(200, 200, 200, 0.6);
            box-shadow: inset 0 0 15px rgba(0,0,0,0.3); pointer-events: auto;
        }
        #joystick-handle {
            position: absolute; width: 60px; height: 60px; border-radius: 50%;
            background: linear-gradient(to bottom, #5a5a5a, #333); border: 1px solid #777;
            box-shadow: 0 3px 5px rgba(0,0,0,0.4), inset 0 1px 1px rgba(255,255,255,0.1);
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            pointer-events: auto; cursor: grab; touch-action: none;
        }
         #joystick-handle:active {
             cursor: grabbing; background: linear-gradient(to top, #5a5a5a, #333);
             box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
         }

        /* Land Button Styling */
        #land-button {
            position: fixed;
            bottom: 20px; right: 20px; left: auto;
            transform: none;
            width: 70px; height: 50px; border-radius: 6px;
            font-size: 16px; font-weight: bold; text-transform: uppercase;
            background: linear-gradient(to bottom, #ffcc00, #cca300); color: #212529;
            border: 1px solid #ffeb99;
            box-shadow: 0 0 0 3px #333, 0 0 0 5px #555, 4px 4px 8px rgba(0,0,0,0.4);
            display: none; justify-content: center; align-items: center;
            z-index: 36; pointer-events: auto; user-select: none;
            -webkit-user-select: none; touch-action: manipulation;
            transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;
        }
         #land-button:active {
             background: linear-gradient(to top, #ffcc00, #cca300);
             box-shadow: 0 0 0 3px #333, 0 0 0 5px #555, inset 0 3px 5px rgba(0, 0, 0, 0.3);
             transform: scale(0.95);
             color: #000;
         }

        /* --- POI Checklist Styling --- */
        #checklist-toggle {
            position: fixed;
            top: 8px;
            right: 8px;
            width: 40px; height: 40px;
            background: rgba(80, 80, 80, 0.7);
            border: 1px solid #aaa;
            color: #fff;
            border-radius: 5px;
            font-size: 24px;
            z-index: 38;
            cursor: pointer;
        }
        #poi-checklist-panel {
            position: fixed;
            top: 60px;
            right: 8px;
            width: 220px;
            max-height: calc(100vh - 80px);
            background: rgba(40,40,40,0.95);
            border: 1px solid #888;
            border-radius: 5px;
            color: #fff;
            padding: 10px;
            z-index: 37;
            overflow-y: auto;
            transform: translateX(120%);
            transition: transform 0.4s ease-in-out;
        }
        #poi-checklist-panel.visible {
            transform: translateX(0);
        }
        #poi-checklist-panel h3 { margin-top: 0; text-align: center; }
        #poi-list { list-style: none; padding: 0; margin: 0; font-size: 14px; }
        #poi-list li { padding: 4px 0; border-bottom: 1px solid #555; }
        #poi-list li.visited { color: #8cff8c; text-decoration: line-through; }

        /* --- Landscape Orientation Styles --- */
        @media (orientation: landscape) {
            #joystick-container { left: auto; right: 20px; }
            #land-button { bottom: 150px; right: 20px; left: auto; transform: none; }
            #debug-info { bottom: 20px; left: 150px; }
        }

    </style>
</head>
<body>
    <!-- UI Elements -->
    <div id="info">
        <span id="keyboard-controls">Controls: Arrows (Turn/Thrust), L (Land)<br></span>
        <span id="land-prompt" style="color: #ffc107; font-weight: bold; display: none;">Press 'L' or Land Button</span><br>
        Speed: <span id="speed-info">0</span> | Angle: <span id="angle-info">0</span>&deg;
    </div>
    <div id="debug-info">Map Image Error! Check console (F12).</div>
    <div id="land-indicator">Nearby: <span id="poi-name">POI</span><br>Press 'L' or Land Button</div>

    <!-- Map Container -->
    <div id="map-container">
        <div id="map-content">
            <!-- POI Markers will be injected here by JS -->
            <img id="map-image" class="loading" src="https://raw.githubusercontent.com/Mikieb1982/HF-Map/main/HF-Map/hoher_flaeming_map.jpg" alt="Hoher Fl√§ming Map">
            <!-- Helicopter and its shadow -->
            <div id="helicopter-container">
                <div id="helicopter">üöÅ</div>
                <div id="helicopter-shadow"></div>
            </div>
        </div>
    </div>

    <!-- POI Info Panel -->
    <div id="info-panel" class="modal-panel">
        <div id="info-content" class="modal-content">
            <h2 id="info-title">Point of Interest</h2>
            <p id="info-description">Details about the point of interest...</p>
            <button id="return-button" class="modal-button">Return to Flight</button>
        </div>
    </div>

    <!-- Completion Panel -->
    <div id="completion-panel" class="modal-panel">
        <div id="completion-content" class="modal-content">
            <h2>Mission Complete!</h2>
            <p>Congratulations! You have visited all 16 points of interest in the Hoher Fl√§ming Nature Park.</p>
            <button id="restart-button" class="modal-button">Fly Again</button>
        </div>
    </div>

    <!-- Joystick Controls -->
    <div id="joystick-container">
        <div id="joystick-base"></div>
        <div id="joystick-handle"></div>
    </div>

    <!-- Land Button (Separate) -->
    <button id="land-button" aria-label="Land">Land</button>

    <!-- POI Checklist -->
    <button id="checklist-toggle">‚ò∞</button>
    <div id="poi-checklist-panel">
        <h3>POI Checklist</h3>
        <ul id="poi-list">
            <!-- List items will be injected here by JS -->
        </ul>
    </div>


    <script>
        // --- Element References ---
        const helicopterContainer = document.getElementById('helicopter-container');
        const helicopterElement = document.getElementById('helicopter');
        const mapContainer = document.getElementById('map-container');
        const mapContent = document.getElementById('map-content');
        const mapImage = document.getElementById('map-image');
        const speedInfo = document.getElementById('speed-info');
        const angleInfo = document.getElementById('angle-info');
        const debugInfo = document.getElementById('debug-info');
        const landIndicator = document.getElementById('land-indicator');
        const landPrompt = document.getElementById('land-prompt');
        const poiNameSpan = document.getElementById('poi-name');
        const infoPanel = document.getElementById('info-panel');
        const infoTitle = document.getElementById('info-title');
        const infoDescription = document.getElementById('info-description');
        const returnButton = document.getElementById('return-button');
        const joystickContainer = document.getElementById('joystick-container');
        const joystickBase = document.getElementById('joystick-base');
        const joystickHandle = document.getElementById('joystick-handle');
        const landButton = document.getElementById('land-button');
        const checklistToggle = document.getElementById('checklist-toggle');
        const poiChecklistPanel = document.getElementById('poi-checklist-panel');
        const poiList = document.getElementById('poi-list');
        const completionPanel = document.getElementById('completion-panel');
        const restartButton = document.getElementById('restart-button');

        console.log("Script starting...");

        // --- Audio Setup (Tone.js) ---
        let audioReady = false;
        let engineSound, landingSound, clickSound;

        function setupAudio() {
            // Helicopter engine: A filtered noise loop
            engineSound = new Tone.Noise("pink").start();
            const filter = new Tone.AutoFilter({
                frequency: "8n",
                baseFrequency: 100,
                octaves: 4
            }).toDestination();
            engineSound.connect(filter);
            engineSound.volume.value = -30; // Start very quiet

            // Landing sound: A simple synth pluck
            landingSound = new Tone.Synth({
                oscillator: { type: "sine" },
                envelope: { attack: 0.01, decay: 0.3, sustain: 0.1, release: 0.5 }
            }).toDestination();

            // UI Click sound
            clickSound = new Tone.Synth({
                oscillator: { type: "triangle" },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 }
            }).toDestination();
            clickSound.volume.value = -10;

            audioReady = true;
            console.log("Audio components initialized.");
        }

        // --- Configuration ---
        const MAP_WIDTH = 2048; const MAP_HEIGHT = 1448;
        const startX = 1364; const startY = 603; // Bad Belzig
        const turnRate = 3.0;
        const forwardThrustPower = 0.15;
        const maxSpeed = 5.0;
        const normalDrag = 0.98;
        const landingZoneDrag = 0.85;
        const minSpeed = 0.05;
        const landingRadius = 60;
        let joystickMaxRadius = 0;

        // --- POI Data (with 'visited' property) ---
        const pointsOfInterest = [
            { id: 1, name: "Stadt und Burg Ziesar", x: 470, y: 150, visited: false, description: "Burg Ziesar is one of Brandenburg's few preserved bishop's residences. This lowland castle features a museum showcasing medieval church and cultural history. Its chapel, once used by Huguenots, holds well-preserved medieval paintings." },
            { id: 2, name: "Gutspark Dahlen", x: 708, y: 357, visited: false, description: "Gutspark Dahlen is a dendrologically significant park in Hoher Fl√§ming, designed in the English style since 1840. It offers historic vistas, pond areas, and impressive blossoms in spring, managed by a local friends' association." },
            { id: 3, name: "Klein Briesener Bach", x: 998, y: 181, visited: false, description: "The Klein Briesener Bach is a small stream originating near Gro√ü Briesen, flowing northwest into the Verlorenwasser. It's the longest tributary of the Verlorenwasser and is part of several protected areas within the Hoher Fl√§ming Nature Park." },
            { id: 4, name: "Paradies Dippmannsdorf", x: 1322, y: 265, visited: false, description: "Known for the 'Dippmannsdorfer Paradies' restaurant, this area offers good German cuisine with views of green landscapes. A nearby nature reserve, also called 'Das Paradies', features a headwater with over 30 springs, perfect for a walk." },
            { id: 5, name: "T√∂pferort G√∂rzke", x: 416, y: 439, visited: false, description: "G√∂rzke is a traditional pottery village. Visitors can explore local potteries, each with unique patterns, and visit the Crafts Museum. The T√∂pferwanderweg (Pottery Hiking Trail) offers scenic views of the Buckau lowlands." },
            { id: 6, name: "Hagelberg", x: 946, y: 719, visited: false, description: "Hagelberg is known for the Battle of Hagelberg in 1813, a significant event during the Napoleonic Wars. A monument commemorates this historical site. It's a key point in the Hoher Fl√§ming region's history." },
            { id: 7, name: "Bad Belzig mit Burg Eisenhardt", x: 1364, y: 603, visited: false, description: "Bad Belzig is home to Burg Eisenhardt, a historic castle with a building history spanning 3,000 years. The castle features a local history museum and its tower, the 'Butterturm', offers panoramic views of the town and Fl√§ming landscape." },
            { id: 8, name: "Aussichtspunkt Belziger Landschaftswiesen", x: 1616, y: 501, visited: false, description: "This viewpoint offers impressive views of the Belziger Landschaftswiesen, a 41 square kilometer lowland area and an important bird sanctuary. It's a crucial habitat for meadow breeders and great bustards, especially in winter when thousands of geese and ducks visit." },
            { id: 9, name: "Wiesenburg mit Schloss und Park", x: 836, y: 843, visited: false, description: "Wiesenburg features a picturesque castle and park, one of the most dendrologically significant sites in Hoher Fl√§ming. The park, designed in the English style, is publicly accessible and offers beautiful walks around its three ponds." },
            { id: 10, name: "Naturparkzentrum Hoher Fl√§ming", x: 1170, y: 1231, visited: false, description: "The Hoher Fl√§ming Nature Park Center in Raben is the main information hub for visitors. It provides insights into the park's diverse landscape of meadows, forests, and historic villages, and offers details on hiking routes and events." },
            { id: 11, name: "Raben mit Burg Rabenstein", x: 1124, y: 1329, visited: false, description: "Burg Rabenstein is arguably the most important castle in Hoher Fl√§ming, serving historically as a border castle between Brandenburg and Saxony. Visitors can explore the castle grounds and enjoy guided tours of the tower." },
            { id: 12, name: "Niemegk", x: 1624, y: 1135, visited: false, description: "Niemegk is a town in the Hoher Fl√§ming region. It's part of the 'Wegweiser Hoher Fl√§ming' initiative, an online platform providing information on local schools, associations, regional products, and cultural activities." },
            { id: 13, name: "Fl√§mingbuchen", x: 654, y: 1171, visited: false, description: "The Fl√§mingbuchen are unique beech tree islands within the Brandtsheide forest. These beeches are genetically distinct, and their seeds are used for new plantings. The area is known for its lush blueberry forests." },
            { id: 14, name: "Brautrummel mit Riesenstein", x: 1110, y: 1023, visited: false, description: "The Brautrummel is a periglacial dry valley in Hoher Fl√§ming, a natural monument. It features a walkable wooden sculpture titled 'Ein Feldbett f√ºr den Fl√§ming' and is part of a scenic circular hiking trail leading to the 'Riesenstein' (Giant Stone)." },
            { id: 15, name: "Neuendorfer Rummel", x: 1482, y: 1309, visited: false, description: "The Neuendorfer Rummel is one of the deep, narrow dry valleys (Rummeln) formed by the Ice Age in the nature park. These valleys are densely forested and offer a unique hiking experience, leading visitors into their own small world." },
            { id: 16, name: "Garrey mit Aussichtsplattform", x: 1494, y: 1427, visited: false, description: "Garrey features an observation deck at the former 'Altes Wasserwerk' (old waterworks). The site includes a small petting zoo with donkeys, goats, and mountain sheep, and the observation platform is always accessible, offering scenic views." }
        ];

        // --- Game State ---
        let helicopterState = { x: startX, y: startY, angle: -90, speed: 0 };
        let joystickState = { active: false, targetAngle: -90, magnitude: 0 };
        let lastTimestamp = 0; let gameReady = false; let currentNearbyPOI = null; let gameState = 'FLYING';

        // --- Initial Setup Functions ---
        function initializeGame() {
            // Create POI markers on the map and in the checklist
            mapContent.innerHTML = ''; // Clear any previous markers
            poiList.innerHTML = '';
            pointsOfInterest.forEach(poi => {
                // Create map marker
                const marker = document.createElement('div');
                marker.className = 'poi-marker';
                marker.id = `marker-${poi.id}`;
                marker.style.left = `${poi.x}px`;
                marker.style.top = `${poi.y}px`;
                const numberSpan = document.createElement('span');
                numberSpan.className = 'poi-number';
                numberSpan.textContent = poi.id;
                marker.appendChild(numberSpan);
                mapContent.appendChild(marker);

                // Create checklist item
                const listItem = document.createElement('li');
                listItem.id = `checklist-item-${poi.id}`;
                listItem.textContent = `${poi.id}. ${poi.name}`;
                poiList.appendChild(listItem);
            });
            // Re-add the map image and helicopter container
            mapContent.appendChild(mapImage);
            mapContent.appendChild(helicopterContainer);
        }

        // --- Image Loading Check ---
        mapImage.onload = () => { console.log("DEBUG: mapImage.onload fired!"); debugInfo.style.display = 'none'; mapImage.classList.remove('loading', 'error'); gameReady = true; console.log("DEBUG: gameReady set to true."); calculateJoystickRadius(); centerViewOnHelicopter(); };
        mapImage.onerror = () => { console.error("DEBUG: mapImage.onerror fired!"); debugInfo.textContent = "Error loading map image!"; debugInfo.style.display = 'block'; mapImage.classList.remove('loading'); mapImage.classList.add('error'); gameReady = false; };
        if (mapImage.complete && mapImage.naturalWidth > 0) { mapImage.onload(); } else if (mapImage.complete) { mapImage.onerror(); } else { console.log("DEBUG: Image not yet complete."); }

        // --- Keyboard Control Listeners (Simplified for testing) ---
        document.addEventListener('keydown', (event) => { if (gameState === 'SHOWING_INFO' || gameState === 'COMPLETE') return; if ((event.key === 'l' || event.key === 'L') && gameState === 'NEAR_POI' && currentNearbyPOI) { event.preventDefault(); landAndShowInfo(currentNearbyPOI); return; } switch (event.key) { case 'ArrowLeft': joystickState.targetAngle = (joystickState.targetAngle - 5 + 360) % 360; joystickState.active = true; break; case 'ArrowRight': joystickState.targetAngle = (joystickState.targetAngle + 5) % 360; joystickState.active = true; break; case 'ArrowUp': joystickState.magnitude = Math.min(1, joystickState.magnitude + 0.1); joystickState.active = true; break; case 'ArrowDown': joystickState.magnitude = Math.max(0, joystickState.magnitude - 0.1); joystickState.active = true; break; } });

        // --- Joystick Touch Listeners ---
        let joystickActiveTouchId = null;
        let baseRect, baseCenterX, baseCenterY;

        function calculateJoystickRadius() { if(joystickBase && joystickHandle) { joystickMaxRadius = joystickBase.offsetWidth / 2 - joystickHandle.offsetWidth / 2; baseRect = joystickBase.getBoundingClientRect(); baseCenterX = baseRect.left + baseRect.width / 2; baseCenterY = baseRect.top + baseRect.height / 2; } else { joystickMaxRadius = 50; } }
        function handleJoystickTouch(event) {
            if (gameState === 'SHOWING_INFO' || gameState === 'COMPLETE' || !joystickMaxRadius) return;
            // Start audio on first interaction
            if (!audioReady) {
                Tone.start().then(setupAudio);
            }
            event.preventDefault();
            for (let i = 0; i < event.changedTouches.length; i++) {
                let touch = event.changedTouches[i];
                if (event.type === 'touchstart') { if (joystickActiveTouchId === null && (touch.target === joystickHandle || touch.target === joystickBase)) { joystickActiveTouchId = touch.identifier; joystickState.active = true; updateJoystick(touch.clientX, touch.clientY); } }
                else if (event.type === 'touchmove') { if (touch.identifier === joystickActiveTouchId) updateJoystick(touch.clientX, touch.clientY); }
                else if (event.type === 'touchend' || event.type === 'touchcancel') { if (touch.identifier === joystickActiveTouchId) { joystickActiveTouchId = null; joystickState.active = false; joystickState.magnitude = 0; joystickHandle.style.transform = `translate(-50%, -50%)`; joystickHandle.style.left = `50%`; joystickHandle.style.top = `50%`; } }
            }
        }
        function updateJoystick(touchX, touchY) { let deltaX = touchX - baseCenterX; let deltaY = touchY - baseCenterY; let angleRad = Math.atan2(deltaY, deltaX); joystickState.targetAngle = angleRad * (180 / Math.PI); let distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY); let clampedDistance = Math.min(distance, joystickMaxRadius); joystickState.magnitude = joystickMaxRadius > 0 ? (clampedDistance / joystickMaxRadius) : 0; let handleX = (Math.cos(angleRad) * clampedDistance); let handleY = (Math.sin(angleRad) * clampedDistance); joystickHandle.style.left = `calc(50% + ${handleX}px)`; joystickHandle.style.top = `calc(50% + ${handleY}px)`; joystickHandle.style.transform = `translate(-50%, -50%)`; }
        document.addEventListener('touchstart', handleJoystickTouch, { passive: false }); document.addEventListener('touchmove', handleJoystickTouch, { passive: false }); document.addEventListener('touchend', handleJoystickTouch, { passive: false }); document.addEventListener('touchcancel', handleJoystickTouch, { passive: false }); window.addEventListener('resize', calculateJoystickRadius);

        // --- UI Button Listeners ---
        returnButton.addEventListener('click', () => { if(audioReady) clickSound.triggerAttackRelease("C5", "8n"); hideInfoAndResumeFlight(); });
        landButton.addEventListener('touchstart', (event) => { event.preventDefault(); if (gameState === 'NEAR_POI' && currentNearbyPOI) landAndShowInfo(currentNearbyPOI); }, { passive: false });
        landButton.addEventListener('click', () => { if(audioReady) clickSound.triggerAttackRelease("C5", "8n"); if (gameState === 'NEAR_POI' && currentNearbyPOI) landAndShowInfo(currentNearbyPOI); });
        checklistToggle.addEventListener('click', () => { poiChecklistPanel.classList.toggle('visible'); });
        restartButton.addEventListener('click', () => { location.reload(); }); // Simple restart

        // --- Game Loop ---
        function gameLoop(timestamp) { if (!lastTimestamp) lastTimestamp = timestamp; const deltaTime = (timestamp - lastTimestamp) / (1000 / 60); lastTimestamp = timestamp; if (gameReady && gameState !== 'SHOWING_INFO' && gameState !== 'COMPLETE') { update(deltaTime); render(); centerViewOnHelicopter(); } requestAnimationFrame(gameLoop); }

        // --- Update Logic ---
        function update(dt) {
            let wasNearPOI = (gameState === 'NEAR_POI');
            let foundNearbyPOI = null;
            for (const poi of pointsOfInterest) {
                if (!poi.visited && Math.sqrt(Math.pow(helicopterState.x - poi.x, 2) + Math.pow(helicopterState.y - poi.y, 2)) < landingRadius) {
                    foundNearbyPOI = poi;
                    break;
                }
            }

            if (foundNearbyPOI) {
                if (!wasNearPOI) console.log(`DEBUG: Entering landing zone for POI ${foundNearbyPOI.id}`);
                gameState = 'NEAR_POI';
                currentNearbyPOI = foundNearbyPOI;
            } else {
                if (wasNearPOI) console.log("DEBUG: Exiting landing zone");
                if (gameState !== 'SHOWING_INFO') {
                    gameState = 'FLYING';
                    currentNearbyPOI = null;
                }
            }

            if (joystickState.active) {
                let currentAngle = helicopterState.angle;
                let targetAngle = joystickState.targetAngle;
                let angleDiff = targetAngle - currentAngle;
                while (angleDiff <= -180) angleDiff += 360;
                while (angleDiff > 180) angleDiff -= 360;
                let turnAmount = turnRate * dt;
                if (Math.abs(angleDiff) < turnAmount) {
                    helicopterState.angle = targetAngle;
                } else {
                    helicopterState.angle += (angleDiff > 0 ? 1 : -1) * turnAmount;
                }
                helicopterState.angle = (helicopterState.angle + 360) % 360;
            }

            let acceleration = 0;
            if (joystickState.active) {
                acceleration += forwardThrustPower * joystickState.magnitude;
            }
            helicopterState.speed += acceleration * dt;

            const currentDrag = (gameState === 'NEAR_POI') ? landingZoneDrag : normalDrag;
            helicopterState.speed *= Math.pow(currentDrag, dt);

            if (helicopterState.speed < minSpeed && !joystickState.active) {
                if (gameState !== 'NEAR_POI' || helicopterState.speed < 0.01) { // Allow slight movement in landing zone
                    helicopterState.speed = 0;
                }
            }
            helicopterState.speed = Math.max(0, Math.min(helicopterState.speed, maxSpeed));

            const angleRad = helicopterState.angle * (Math.PI / 180);
            const vx = Math.cos(angleRad) * helicopterState.speed;
            const vy = Math.sin(angleRad) * helicopterState.speed;

            helicopterState.x += vx * dt;
            helicopterState.y += vy * dt;

            // Clamp helicopter position to map boundaries
            helicopterState.x = Math.max(0, Math.min(MAP_WIDTH, helicopterState.x));
            helicopterState.y = Math.max(0, Math.min(MAP_HEIGHT, helicopterState.y));

            if (gameState === 'NEAR_POI') {
                poiNameSpan.textContent = currentNearbyPOI.name;
                landIndicator.style.display = 'block';
                landPrompt.style.display = 'inline';
                landButton.style.display = 'flex';
                joystickContainer.style.display = 'block'; // Keep joystick visible when near POI
            } else if (gameState === 'FLYING') {
                landIndicator.style.display = 'none';
                landPrompt.style.display = 'none';
                landButton.style.display = 'none';
                currentNearbyPOI = null;
            }
        }

        // --- Render Logic ---
        function render() {
            helicopterContainer.style.left = `${helicopterState.x}px`;
            helicopterContainer.style.top = `${helicopterState.y}px`;
            const visualAngle = helicopterState.angle + 90; // Adjust for emoji orientation
            helicopterContainer.style.transform = `translate(-50%, 0%) rotate(${visualAngle}deg)`;

            speedInfo.textContent = helicopterState.speed.toFixed(2);
            let displayAngle = Math.round((helicopterState.angle + 90 + 360) % 360); // Normalize to 0-360
            angleInfo.textContent = `${displayAngle}¬∞`;

            // Update audio based on state
            if (audioReady) {
                const speedRatio = helicopterState.speed / maxSpeed;
                engineSound.volume.value = -30 + (speedRatio * 25); // from -30dB to -5dB
                engineSound.volume.rampTo(engineSound.volume.value, 0.1);
                engineSound.playbackRate = 1 + speedRatio;
            }
        }

        // --- Map Scrolling Function ---
        function centerViewOnHelicopter() {
            const scrollX = helicopterState.x - mapContainer.clientWidth / 2;
            const scrollY = helicopterState.y - mapContainer.clientHeight / 2;
            mapContainer.scrollTo({ left: scrollX, top: scrollY, behavior: 'auto' });
        }

        // --- Landing and Info Panel Functions ---
        function landAndShowInfo(poi) {
            gameState = 'SHOWING_INFO';
            if(audioReady) landingSound.triggerAttackRelease("A3", "4n");
            currentNearbyPOI = poi;
            helicopterState.speed = 0; // Stop helicopter movement
            joystickState.active = false;
            joystickState.magnitude = 0;
            joystickHandle.style.transform = `translate(-50%, -50%)`;
            joystickHandle.style.left = `50%`;
            joystickHandle.style.top = `50%`;
            joystickActiveTouchId = null; // Release any active joystick touch

            // Hide flight UI
            landIndicator.style.display = 'none';
            landPrompt.style.display = 'none';
            landButton.style.display = 'none';
            joystickContainer.style.display = 'none';

            // Mark POI as visited
            if (!poi.visited) {
                poi.visited = true;
                document.getElementById(`marker-${poi.id}`).classList.add('visited');
                document.getElementById(`checklist-item-${poi.id}`).classList.add('visited');
                checkCompletion();
            }

            // Show info panel
            infoTitle.textContent = `${poi.id}. ${poi.name}`;
            infoDescription.innerHTML = poi.description.replace(/\n/g, '<br>'); // Replace newlines with <br> for HTML display
            infoPanel.classList.add('visible');
        }

        function hideInfoAndResumeFlight() {
            if (!currentNearbyPOI) return; // Should not happen if called correctly
            infoPanel.classList.remove('visible');
            joystickContainer.style.display = 'block'; // Show joystick again
            // Optionally reposition helicopter slightly after landing, or keep it at POI
            helicopterState.x = currentNearbyPOI.x;
            helicopterState.y = currentNearbyPOI.y;
            helicopterState.speed = 0; // Ensure speed is zero when resuming from POI
            centerViewOnHelicopter(); // Recenter view
            gameState = 'FLYING'; // Resume flight state
            calculateJoystickRadius(); // Recalculate in case of resize
        }

        function checkCompletion() {
            const allVisited = pointsOfInterest.every(p => p.visited);
            if (allVisited) {
                console.log("Mission Complete!");
                gameState = 'COMPLETE';
                setTimeout(() => {
                    completionPanel.classList.add('visible');
                    infoPanel.classList.remove('visible'); // Hide info panel if open
                }, 1000); // Show after a short delay
            }
        }

        // --- Start Game ---
        initializeGame();
        requestAnimationFrame(() => {
            calculateJoystickRadius();
            console.log("DEBUG: Starting game loop...");
            requestAnimationFrame(gameLoop);
        });
    </script>
</body>
</html>
