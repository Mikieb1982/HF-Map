<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Map - Hoher Fl√§ming</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
          integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Ensure map fills its container */
        #map {
            height: 100%;
            width: 100%;
            z-index: 10; /* Ensure map is behind sidebar toggle */
        }

        /* Custom scrollbar for sidebar */
        .sidebar-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .sidebar-scroll::-webkit-scrollbar-track {
            background: #374151; /* gray-700 */
            border-radius: 10px;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: #6b7280; /* gray-500 */
            border-radius: 10px;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb:hover {
            background: #9ca3af; /* gray-400 */
        }

        /* Style for highlighted routes */
        .highlighted-route {
            stroke-width: 6;
            stroke-opacity: 1.0;
            filter: brightness(1.2); /* Make highlight more visible */
        }

        /* Loading indicator style */
        #loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 1.1em;
            z-index: 1000; /* Ensure it's above map but below modals if any */
            display: none; /* Hidden by default */
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        /* Sidebar toggle button for mobile */
        #sidebar-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 400; /* Above map, below sidebar */
        }

        /* Sidebar transition */
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }

        /* Leaflet Font Awesome Icon Styling */
        .leaflet-fa-icon {
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            color: white; /* Icon color */
            text-align: center;
            line-height: 24px; /* Adjust based on icon size */
            font-size: 14px; /* Adjust icon size */
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
            border: 1px solid rgba(0,0,0,0.2);
        }
        /* Popup adjustments */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }
        .leaflet-popup-content {
            margin: 12px;
            font-size: 13px;
            line-height: 1.5;
        }
        .leaflet-popup-content b, .leaflet-popup-content strong {
            font-weight: 600;
            color: #374151; /* gray-700 */
        }
    </style>
</head>
<body class="font-sans antialiased bg-gray-100 overflow-hidden"> {/* Prevent body scroll */}

    <div class="flex flex-col md:flex-row h-screen relative">

        <div id="map-container" class="flex-grow h-1/2 md:h-full relative">
            <div id="map"></div>
            <div id="loading-indicator" class="text-gray-700 shadow-md flex items-center">
                <i class="fas fa-spinner fa-spin mr-2"></i>Loading...
            </div>
             <button id="sidebar-toggle" class="md:hidden bg-white p-2 rounded-md shadow-md text-gray-600 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
            </button>
        </div>

        <div id="sidebar" class="w-full md:w-80 lg:w-96 bg-gray-800 text-white p-4 shadow-lg overflow-y-auto sidebar-scroll h-1/2 md:h-full fixed md:relative right-0 top-0 transform translate-x-full md:translate-x-0 z-50">
             <button id="sidebar-close" class="md:hidden absolute top-2 right-2 text-gray-300 hover:text-white p-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <h2 class="text-xl font-semibold mb-4 border-b border-gray-600 pb-2">Filter & Search</h2>

            <div class="mb-4">
                <label for="search-input" class="block text-sm font-medium text-gray-300 mb-1">Search</label>
                <input type="text" id="search-input" placeholder="Search locations, routes..." class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-white placeholder-gray-400">
            </div>

            <div class="mb-4 p-3 bg-gray-700 rounded-md">
                <h3 class="text-lg font-medium mb-2">Routes</h3>

                <div class="mb-3">
                    <label for="route-type" class="block text-sm font-medium text-gray-300 mb-1">Type</label>
                    <select id="route-type" class="w-full px-3 py-2 bg-gray-600 border border-gray-500 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                        <option value="all">All Routes</option>
                        <option value="walking">Walking</option>
                        <option value="cycling">Cycling</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="difficulty-level" class="block text-sm font-medium text-gray-300 mb-1">Difficulty</label>
                    <select id="difficulty-level" class="w-full px-3 py-2 bg-gray-600 border border-gray-500 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                        <option value="all">Any Difficulty</option>
                        <option value="easy">Easy</option>
                        <option value="medium">Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="max-length" class="block text-sm font-medium text-gray-300 mb-1">Max Length (km)</label>
                    <input type="range" id="max-length" min="0" max="150" value="150" step="5" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer range-lg accent-blue-500">
                    <span id="max-length-value" class="text-sm text-gray-400 float-right">150 km</span>
                </div>

                <div class="mb-3">
                    <label for="max-duration" class="block text-sm font-medium text-gray-300 mb-1">Max Duration (h)</label>
                    <input type="range" id="max-duration" min="0" max="50" value="50" step="1" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer range-lg accent-blue-500">
                     <span id="max-duration-value" class="text-sm text-gray-400 float-right">50 h</span>
                </div>

                <div class="mb-3">
                    <label for="start-point" class="block text-sm font-medium text-gray-300 mb-1">Starting Point / Named Route</label>
                    <select id="start-point" class="w-full px-3 py-2 bg-gray-600 border border-gray-500 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                        <option value="all">Any Start Point</option>
                        <option value="bad-belzig">Bad Belzig</option>
                        <option value="wiesenburg">Wiesenburg</option>
                        <option value="niemegk">Niemegk</option>
                        <option value="raben">Raben</option>
                        <option value="burgenwanderweg">Burgenwanderweg</option>
                        <option value="kunstwanderweg">Kunstwanderweg</option>
                    </select>
                </div>

                 <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-300 mb-1">Criteria</label>
                    <div class="space-y-1 text-sm">
                        <div class="flex items-center">
                            <input id="criteria-public-transport" name="criteria-public-transport" type="checkbox" value="public_transport_accessible" class="h-4 w-4 text-blue-600 bg-gray-600 border-gray-500 rounded focus:ring-blue-500 filter-checkbox">
                            <label for="criteria-public-transport" class="ml-2 block text-gray-300">Accessible by Public Transport</label>
                        </div>
                         <div class="flex items-center">
                            <input id="criteria-family-friendly" name="criteria-family-friendly" type="checkbox" value="family-friendly" class="h-4 w-4 text-blue-600 bg-gray-600 border-gray-500 rounded focus:ring-blue-500 filter-checkbox">
                            <label for="criteria-family-friendly" class="ml-2 block text-gray-300">Family-Friendly</label>
                        </div>
                         <div class="flex items-center">
                            <input id="criteria-stroller-friendly" name="criteria-stroller-friendly" type="checkbox" value="stroller-friendly" class="h-4 w-4 text-blue-600 bg-gray-600 border-gray-500 rounded focus:ring-blue-500 filter-checkbox">
                            <label for="criteria-stroller-friendly" class="ml-2 block text-gray-300">Stroller-Friendly</label>
                        </div>
                         <div class="flex items-center">
                            <input id="criteria-wheelchair-accessible" name="criteria-wheelchair-accessible" type="checkbox" value="wheelchair-accessible" class="h-4 w-4 text-blue-600 bg-gray-600 border-gray-500 rounded focus:ring-blue-500 filter-checkbox">
                            <label for="criteria-wheelchair-accessible" class="ml-2 block text-gray-300">Wheelchair Accessible</label>
                        </div>
                         <div class="flex items-center">
                            <input id="criteria-nordic-walking" name="criteria-nordic-walking" type="checkbox" value="nordic-walking" class="h-4 w-4 text-blue-600 bg-gray-600 border-gray-500 rounded focus:ring-blue-500 filter-checkbox">
                            <label for="criteria-nordic-walking" class="ml-2 block text-gray-300">Nordic Walking Suitable</label>
                        </div>
                         <div class="flex items-center">
                            <input id="criteria-circular" name="criteria-circular" type="checkbox" value="circular" class="h-4 w-4 text-blue-600 bg-gray-600 border-gray-500 rounded focus:ring-blue-500 filter-checkbox">
                            <label for="criteria-circular" class="ml-2 block text-gray-300">Circular Route</label>
                        </div>
                         <div class="flex items-center">
                            <input id="criteria-hiking-trail" name="criteria-hiking-trail" type="checkbox" value="hiking-trail" class="h-4 w-4 text-blue-600 bg-gray-600 border-gray-500 rounded focus:ring-blue-500 filter-checkbox">
                            <label for="criteria-hiking-trail" class="ml-2 block text-gray-300">Major Hiking Trail</label>
                        </div>
                         <div class="flex items-center">
                            <input id="criteria-castle" name="criteria-castle" type="checkbox" value="castle" class="h-4 w-4 text-blue-600 bg-gray-600 border-gray-500 rounded focus:ring-blue-500 filter-checkbox">
                            <label for="criteria-castle" class="ml-2 block text-gray-300">Features Castles</label>
                        </div>
                         <div class="flex items-center">
                            <input id="criteria-pottery" name="criteria-pottery" type="checkbox" value="pottery" class="h-4 w-4 text-blue-600 bg-gray-600 border-gray-500 rounded focus:ring-blue-500 filter-checkbox">
                            <label for="criteria-pottery" class="ml-2 block text-gray-300">Features Pottery</label>
                        </div>
                         <div class="flex items-center">
                            <input id="criteria-church" name="criteria-church" type="checkbox" value="church" class="h-4 w-4 text-blue-600 bg-gray-600 border-gray-500 rounded focus:ring-blue-500 filter-checkbox">
                            <label for="criteria-church" class="ml-2 block text-gray-300">Features Churches</label>
                        </div>
                         <div class="flex items-center">
                            <input id="criteria-art" name="criteria-art" type="checkbox" value="art" class="h-4 w-4 text-blue-600 bg-gray-600 border-gray-500 rounded focus:ring-blue-500 filter-checkbox">
                            <label for="criteria-art" class="ml-2 block text-gray-300">Features Art</label>
                        </div>
                    </div>
                </div>
            </div>

             <div class="mb-4 p-3 bg-gray-700 rounded-md">
                <h3 class="text-lg font-medium mb-2">Points of Interest</h3>
                 <label class="block text-sm font-medium text-gray-300 mb-1">Toggle Visibility</label>
                 <div class="space-y-1 text-sm">
                    <div class="flex items-center">
                        <input id="toggle-accommodation" name="toggle-accommodation" type="checkbox" checked class="h-4 w-4 text-blue-600 bg-gray-600 border-gray-500 rounded focus:ring-blue-500 poi-toggle-checkbox" data-layer-group="accommodation">
                        <label for="toggle-accommodation" class="ml-2 block text-gray-300"><i class="fas fa-bed w-4 mr-1 text-center"></i> Accommodation</label>
                    </div>
                     <div class="flex items-center">
                        <input id="toggle-amenities" name="toggle-amenities" type="checkbox" checked class="h-4 w-4 text-blue-600 bg-gray-600 border-gray-500 rounded focus:ring-blue-500 poi-toggle-checkbox" data-layer-group="amenities">
                        <label for="toggle-amenities" class="ml-2 block text-gray-300"><i class="fas fa-map-marker-alt w-4 mr-1 text-center"></i> Local Amenities</label>
                    </div>
                 </div>
            </div>

             <div class="mb-4 p-3 bg-gray-700 rounded-md">
                <h3 class="text-lg font-medium mb-2">Weather (Hoher Fl√§ming)</h3>
                <div id="weather-widget" class="text-sm text-gray-300">
                    <p><i class="fas fa-spinner fa-spin mr-1"></i> Loading weather...</p>
                    </div>
            </div>

            <div class="flex space-x-2 mt-4 sticky bottom-0 bg-gray-800 py-3 -mx-4 px-4 border-t border-gray-700">
                <button id="apply-filters-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out flex items-center justify-center">
                    <i class="fas fa-filter mr-2"></i> Apply Filters
                </button>
                <button id="reset-filters-btn" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out flex items-center justify-center">
                    <i class="fas fa-undo mr-2"></i> Reset
                </button>
            </div>

        </div>

    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const mapElement = document.getElementById('map');
            const loadingIndicator = document.getElementById('loading-indicator');
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebarClose = document.getElementById('sidebar-close');
            const routeTypeSelect = document.getElementById('route-type');
            const difficultyLevelSelect = document.getElementById('difficulty-level');
            const maxLengthSlider = document.getElementById('max-length');
            const maxLengthValue = document.getElementById('max-length-value');
            const maxDurationSlider = document.getElementById('max-duration');
            const maxDurationValue = document.getElementById('max-duration-value');
            const startPointSelect = document.getElementById('start-point');
            const criteriaCheckboxes = document.querySelectorAll('.filter-checkbox');
            const poiToggleCheckboxes = document.querySelectorAll('.poi-toggle-checkbox');
            const searchInput = document.getElementById('search-input');
            const applyFiltersBtn = document.getElementById('apply-filters-btn');
            const resetFiltersBtn = document.getElementById('reset-filters-btn');
            const weatherWidget = document.getElementById('weather-widget');

            // --- Map Initialization ---
            const centerLat = 52.147; // Approximate center of Hoher Fl√§ming
            const centerLng = 12.589; // Approximate center of Hoher Fl√§ming
            const initialZoom = 10; // Adjusted for a broader view of the region
            const map = L.map(mapElement, {
                zoomControl: true // Default Leaflet zoom control
            }).setView([centerLat, centerLng], initialZoom);

            // --- Base Layers ---
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map); // Add OSM as default base layer

            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                maxZoom: 19
            });

            // Layer control for switching base maps
            const baseMaps = {
                "Karte": osmLayer,
                "Satellit": satelliteLayer
            };
            const layerControl = L.control.layers(baseMaps).addTo(map); // Add layer control to map

            // --- Data Storage ---
            let allRoutesData = null; // To store fetched or defined route data
            let allPOIsData = null;   // To store fetched or defined POI data
            let routeLayers = [];     // Array to keep track of currently displayed route layers
            let poiLayers = {};       // Object to keep track of POI layer groups

            // --- Placeholder Data (Updated with PDF info v3 & User Coords - route coordinates are still placeholders) ---
            // Note: Coordinates are illustrative and do not represent actual route paths.
            // Lengths and durations are more aligned with typical expectations for such routes.
            const placeholderRoutes = {
                "type": "FeatureCollection",
                "features": [
                    // --- Major Walking Routes ---
                    {
                        "type": "Feature",
                        "geometry": { "type": "LineString", "coordinates": [[12.590, 52.141], [12.65, 52.15], [12.70, 52.12], [12.77, 52.18], [12.70, 52.20], [12.60, 52.22], [12.50, 52.18], [12.4521, 52.1121], [12.4, 51.98]] },
                        "properties": { "name": "Burgenwanderweg (Hoher Fl√§ming Section)", "type": "walking", "length_km": 147.0, "duration_h": 40.0, "start_point": "bad-belzig", "end_point": "various", "public_transport_accessible": true, "tags": ["hiking-trail", "castle", "history", "nature", "long-distance", "e11"], "difficulty": "medium", "description": "A long-distance hiking trail connecting castles and historical sites across the Hoher Fl√§ming region. Part of the European long-distance path E11." }
                    },
                    {
                        "type": "Feature",
                        "geometry": { "type": "LineString", "coordinates": [[12.58, 52.14], [12.55, 52.10], [12.60, 52.08], [12.65, 52.11], [12.63, 52.15]] },
                        "properties": { "name": "Kunstwanderweg (Hoher Fl√§ming Section)", "type": "walking", "length_km": 18.0, "duration_h": 5.0, "start_point": "bad-belzig", "end_point": "wiesenburg", "public_transport_accessible": true, "tags": ["art", "nature", "culture", "hiking-trail"], "difficulty": "easy", "description": "A trail connecting Bad Belzig and Wiesenburg, featuring various art installations along the way." }
                    },
                    // --- Shorter/Local Walking Routes ---
                    {
                        "type": "Feature",
                        "geometry": { "type": "LineString", "coordinates": [[12.305, 52.137], [12.31, 52.14], [12.30, 52.145], [12.29, 52.142], [12.305, 52.137]] },
                        "properties": { "name": "Wiesenburg Park Circular Walk", "type": "walking", "length_km": 5.0, "duration_h": 1.5, "start_point": "wiesenburg", "public_transport_accessible": true, "tags": ["park", "nature", "family-friendly", "circular", "castle"], "difficulty": "easy", "description": "A pleasant walk through the Wiesenburg Castle park and surrounding nature." }
                    },
                    {
                        "type": "Feature",
                        "geometry": { "type": "LineString", "coordinates": [[12.43, 52.06], [12.44, 52.055], [12.45, 52.065], [12.435, 52.07]] },
                        "properties": { "name": "Rabenstein Castle Loop", "type": "walking", "length_km": 8.0, "duration_h": 2.5, "start_point": "raben", "public_transport_accessible": true, "tags": ["castle", "forest", "nature", "nordic-walking"], "difficulty": "medium", "description": "A scenic loop around Rabenstein Castle, offering views and forest paths." }
                    },
                    {
                        "type": "Feature",
                        "geometry": { "type": "LineString", "coordinates": [[12.68, 52.09], [12.70, 52.08], [12.71, 52.10], [12.69, 52.11]] },
                        "properties": { "name": "Niemegk Town & Country Walk", "type": "walking", "length_km": 6.0, "duration_h": 2.0, "start_point": "niemegk", "public_transport_accessible": true, "tags": ["town", "fields", "easy-walk", "family-friendly"], "difficulty": "easy", "description": "An easy walk exploring the town of Niemegk and its immediate surroundings." }
                    },

                    // --- Cycling Routes ---
                    {
                        "type": "Feature",
                        "geometry": { "type": "LineString", "coordinates": [[12.59, 52.14], [12.45, 52.11], [12.30, 52.13], [12.35, 52.18], [12.50, 52.20]] },
                        "properties": { "name": "Fl√§ming Skate - RK1 (Short Loop)", "type": "cycling", "length_km": 25.0, "duration_h": 2.0, "start_point": "bad-belzig", "public_transport_accessible": true, "tags": ["cycling", "skating", "paved", "family-friendly", "fl√§ming-skate"], "difficulty": "easy", "description": "A shorter loop section of the famous Fl√§ming Skate, suitable for families and casual cyclists." }
                    },
                    {
                        "type": "Feature",
                        "geometry": { "type": "LineString", "coordinates": [[12.59, 52.14], [12.77, 52.18], [12.80, 52.10], [12.68, 52.00], [12.50, 51.95], [12.40, 52.05], [12.59, 52.14]] },
                        "properties": { "name": "Tour de Fl√§ming Castles", "type": "cycling", "length_km": 75.0, "duration_h": 5.0, "start_point": "bad-belzig", "public_transport_accessible": true, "tags": ["cycling", "castle", "history", "scenic"], "difficulty": "medium", "description": "A longer cycling tour connecting several castles and picturesque villages in the Hoher Fl√§ming." }
                    },
                    {
                        "type": "Feature",
                        "geometry": { "type": "LineString", "coordinates": [[12.305, 52.137],[12.10, 52.15], [12.00, 52.05], [12.25, 51.95], [12.45, 52.00], [12.55, 52.08], [12.40, 52.12], [12.305, 52.137]] },
                        "properties": { "name": "Western Fl√§ming Explorer (Cycling)", "type": "cycling", "length_km": 90.0, "duration_h": 6.5, "start_point": "wiesenburg", "public_transport_accessible": false, "tags": ["cycling", "long-distance", "nature", "villages"], "difficulty": "hard", "description": "A challenging cycling route exploring the western parts of Hoher Fl√§ming, featuring varied terrain." }
                    }
                ]
            };

            // --- POI Data (Placeholder - to be expanded) ---
            // Example: allPOIsData = { "type": "FeatureCollection", "features": [ ... POI features ... ] };
            // Each POI feature should have a "properties" object with at least a "name" and a "category" (e.g., "accommodation", "amenity", "viewpoint")
            // And an "icon" property (e.g., "fa-bed", "fa-utensils", "fa-camera") and "iconColor" (e.g., 'blue', 'green')

            // --- Function to Show Loading Indicator ---
            function showLoading(isLoading) {
                loadingIndicator.style.display = isLoading ? 'flex' : 'none';
            }

            // --- Function to Create Custom Icons for POIs (Example) ---
            function createCustomIcon(iconClass, color, size = [28, 28]) {
                return L.divIcon({
                    html: `<i class="fas ${iconClass}" style="color: ${color};"></i>`,
                    className: 'leaflet-fa-icon', // General class for potential global styling
                    iconSize: size,
                    iconAnchor: [size[0] / 2, size[1]], // Point of the icon which will correspond to marker's location
                    popupAnchor: [0, -size[1]]    // Point from which the popup should open relative to the iconAnchor
                });
            }

            // --- Function to Add Routes to Map ---
            function addRoutesToMap(routes) {
                // Clear existing route layers
                routeLayers.forEach(layer => map.removeLayer(layer));
                routeLayers = [];

                if (!routes || !routes.features) {
                    console.warn("No routes to display or invalid route data format.");
                    return;
                }

                routes.features.forEach(route => {
                    const routeLayer = L.geoJSON(route, {
                        style: (feature) => {
                            let color = '#3388ff'; // Default blue
                            if (feature.properties.type === 'walking') color = '#ff7800'; // Orange for walking
                            if (feature.properties.type === 'cycling') color = '#4CAF50'; // Green for cycling
                            if (feature.properties.difficulty === 'hard') color = '#d9534f'; // Red for hard
                            return { color: color, weight: 4, opacity: 0.7 };
                        },
                        onEachFeature: (feature, layer) => {
                            // Create popup content
                            let popupContent = `<b>${feature.properties.name || 'Unnamed Route'}</b>`;
                            if (feature.properties.length_km) popupContent += `<br>Length: ${feature.properties.length_km} km`;
                            if (feature.properties.duration_h) popupContent += `<br>Duration: ${feature.properties.duration_h} h`;
                            if (feature.properties.difficulty) popupContent += `<br>Difficulty: ${feature.properties.difficulty.charAt(0).toUpperCase() + feature.properties.difficulty.slice(1)}`;
                            if (feature.properties.description) popupContent += `<br><small><em>${feature.properties.description}</em></small>`;
                            if (feature.properties.tags) popupContent += `<br><small>Tags: ${feature.properties.tags.join(', ')}</small>`;

                            layer.bindPopup(popupContent);

                            // Highlight on hover
                            layer.on('mouseover', function (e) {
                                this.setStyle({ weight: 6, opacity: 1.0 });
                                if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                                    this.bringToFront();
                                }
                            });
                            layer.on('mouseout', function (e) {
                                routeLayer.resetStyle(this); // Reset to original style
                            });
                        }
                    });
                    routeLayers.push(routeLayer);
                    routeLayer.addTo(map);
                });
                if (routeLayers.length > 0) {
                     // Fit map to bounds of all routes if multiple routes, or zoom to single route
                    const group = new L.featureGroup(routeLayers);
                    map.fitBounds(group.getBounds().pad(0.1)); // Add some padding
                } else if (routes.features.length === 0) {
                    // If no routes match filters, maybe reset to default view or show a message
                    map.setView([centerLat, centerLng], initialZoom);
                }
            }


            // --- Function to Filter Routes ---
            function filterAndDisplayRoutes() {
                showLoading(true);

                // Simulate async operation if data were fetched
                setTimeout(() => {
                    if (!allRoutesData || !allRoutesData.features) {
                        console.warn("Route data not loaded yet.");
                        addRoutesToMap({ type: "FeatureCollection", features: [] }); // Display empty map
                        showLoading(false);
                        return;
                    }

                    const selectedRouteType = routeTypeSelect.value;
                    const selectedDifficulty = difficultyLevelSelect.value;
                    const maxLength = parseFloat(maxLengthSlider.value);
                    const maxDuration = parseFloat(maxDurationSlider.value);
                    const selectedStartPoint = startPointSelect.value;
                    const searchTerm = searchInput.value.toLowerCase();
                    const activeCriteria = Array.from(criteriaCheckboxes)
                                              .filter(cb => cb.checked)
                                              .map(cb => cb.value);

                    const filteredRoutes = allRoutesData.features.filter(route => {
                        const props = route.properties;
                        let matches = true;

                        if (selectedRouteType !== 'all' && props.type !== selectedRouteType) matches = false;
                        if (selectedDifficulty !== 'all' && props.difficulty !== selectedDifficulty) matches = false;
                        if (props.length_km && props.length_km > maxLength) matches = false;
                        if (props.duration_h && props.duration_h > maxDuration) matches = false;

                        if (selectedStartPoint !== 'all') {
                            // Check if the start_point matches or if the route name itself matches (for named routes like Burgenwanderweg)
                            if (props.start_point !== selectedStartPoint && props.name.toLowerCase().indexOf(selectedStartPoint.replace(/-/g, " ")) === -1) {
                                matches = false;
                            }
                        }


                        if (searchTerm) {
                            const nameMatch = props.name && props.name.toLowerCase().includes(searchTerm);
                            const tagsMatch = props.tags && props.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                            const descriptionMatch = props.description && props.description.toLowerCase().includes(searchTerm);
                            if (!nameMatch && !tagsMatch && !descriptionMatch) matches = false;
                        }

                        if (activeCriteria.length > 0) {
                            if (!props.tags || !activeCriteria.every(crit => props.tags.includes(crit))) {
                                matches = false;
                            }
                        }
                        return matches;
                    });

                    addRoutesToMap({ type: "FeatureCollection", features: filteredRoutes });
                    showLoading(false);
                }, 200); // Short delay to simulate loading and allow UI to update
            }

            // --- Function to Add POIs to Map ---
            function addPOIsToMap(pois) {
                // Clear existing POI layers first by group
                Object.values(poiLayers).forEach(group => map.removeLayer(group));
                poiLayers = {}; // Reset the poiLayers object

                if (!pois || !pois.features) {
                    console.warn("No POIs to display or invalid POI data format.");
                    return;
                }

                pois.features.forEach(poi => {
                    const category = poi.properties.category || 'general';
                    const iconClass = poi.properties.icon || 'fa-map-marker-alt'; // Default icon
                    const iconColor = poi.properties.iconColor || '#007bff'; // Default color (blue)

                    if (!poiLayers[category]) {
                        poiLayers[category] = L.layerGroup(); // Create a new layer group for the category if it doesn't exist
                    }

                    const marker = L.marker([poi.geometry.coordinates[1], poi.geometry.coordinates[0]], { // Lat, Lng for Leaflet
                        icon: createCustomIcon(iconClass, iconColor)
                    });

                    let popupContent = `<b>${poi.properties.name || 'Point of Interest'}</b>`;
                    if (poi.properties.description) popupContent += `<br>${poi.properties.description}`;
                    if (poi.properties.address) popupContent += `<br><small>${poi.properties.address}</small>`;
                    marker.bindPopup(popupContent);

                    poiLayers[category].addLayer(marker); // Add marker to its category group
                });

                // Add all initially visible POI groups to the map (based on checkbox state)
                poiToggleCheckboxes.forEach(checkbox => {
                    const layerGroupName = checkbox.dataset.layerGroup;
                    if (checkbox.checked && poiLayers[layerGroupName]) {
                        poiLayers[layerGroupName].addTo(map);
                    }
                });
            }

            // --- Function to Toggle POI Layer Visibility ---
            function togglePOILayer(layerGroupName, isVisible) {
                if (poiLayers[layerGroupName]) {
                    if (isVisible) {
                        poiLayers[layerGroupName].addTo(map);
                    } else {
                        map.removeLayer(poiLayers[layerGroupName]);
                    }
                }
            }


            // --- Function to Fetch Weather Data (Hoher Fl√§ming - using Bad Belzig as reference) ---
            async function fetchWeather() {
                // Using Open-Meteo API (free, no API key required for basic use)
                // Coordinates for Bad Belzig: lat 52.14, lon 12.59
                const weatherApiUrl = `https://api.open-meteo.com/v1/forecast?latitude=52.14&longitude=12.59&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,rain,showers,snowfall,weather_code,cloud_cover,wind_speed_10m,wind_direction_10m&timezone=Europe%2FBerlin`;

                try {
                    const response = await fetch(weatherApiUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    if (data && data.current) {
                        const current = data.current;
                        const weatherDescription = getWeatherDescription(current.weather_code);
                        const weatherIcon = getWeatherIcon(current.weather_code, current.is_day);

                        weatherWidget.innerHTML = `
                            <div class="flex items-center">
                                <i class="fas ${weatherIcon} fa-2x mr-3 text-yellow-400"></i>
                                <div>
                                    <p class="font-semibold">${current.temperature_2m}¬∞C (Feels like ${current.apparent_temperature}¬∞C)</p>
                                    <p>${weatherDescription}</p>
                                    <p>Humidity: ${current.relative_humidity_2m}%</p>
                                    <p>Wind: ${current.wind_speed_10m} km/h</p>
                                </div>
                            </div>
                        `;
                    } else {
                        weatherWidget.innerHTML = '<p><i class="fas fa-exclamation-circle mr-1"></i> Weather data unavailable.</p>';
                    }
                } catch (error) {
                    console.error("Error fetching weather:", error);
                    weatherWidget.innerHTML = '<p><i class="fas fa-exclamation-circle mr-1"></i> Could not load weather.</p>';
                }
            }

            function getWeatherIcon(code, isDay = 1) {
                // Simplified WMO Weather interpretation codes to Font Awesome icons
                if (code === 0) return isDay ? 'fa-sun' : 'fa-moon'; // Clear sky
                if (code === 1 || code === 2 || code === 3) return isDay ? 'fa-cloud-sun' : 'fa-cloud-moon'; // Mainly clear, partly cloudy, overcast
                if (code >= 45 && code <= 48) return 'fa-smog'; // Fog
                if (code >= 51 && code <= 57) return 'fa-cloud-rain'; // Drizzle
                if (code >= 61 && code <= 67) return 'fa-cloud-showers-heavy'; // Rain
                if (code >= 71 && code <= 77) return 'fa-snowflake'; // Snow fall
                if (code >= 80 && code <= 82) return 'fa-cloud-showers-heavy'; // Rain showers
                if (code >= 85 && code <= 86) return 'fa-snowflake'; // Snow showers
                if (code >= 95 && code <= 99) return 'fa-bolt'; // Thunderstorm
                return 'fa-question-circle'; // Default
            }

            function getWeatherDescription(code) {
                // WMO Weather interpretation codes
                const descriptions = {
                    0: 'Clear sky', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast',
                    45: 'Fog', 48: 'Depositing rime fog',
                    51: 'Light drizzle', 53: 'Moderate drizzle', 55: 'Dense drizzle',
                    56: 'Light freezing drizzle', 57: 'Dense freezing drizzle',
                    61: 'Slight rain', 63: 'Moderate rain', 65: 'Heavy rain',
                    66: 'Light freezing rain', 67: 'Heavy freezing rain',
                    71: 'Slight snow fall', 73: 'Moderate snow fall', 75: 'Heavy snow fall',
                    77: 'Snow grains',
                    80: 'Slight rain showers', 81: 'Moderate rain showers', 82: 'Violent rain showers',
                    85: 'Slight snow showers', 86: 'Heavy snow showers',
                    95: 'Thunderstorm', 96: 'Thunderstorm with slight hail', 99: 'Thunderstorm with heavy hail'
                };
                return descriptions[code] || 'Unknown weather';
            }


            // --- Event Listeners ---
            // Slider value updates
            maxLengthSlider.addEventListener('input', (e) => {
                maxLengthValue.textContent = `${e.target.value} km`;
            });
            maxDurationSlider.addEventListener('input', (e) => {
                maxDurationValue.textContent = `${e.target.value} h`;
            });

            // Apply and Reset Filters
            applyFiltersBtn.addEventListener('click', filterAndDisplayRoutes);
            resetFiltersBtn.addEventListener('click', () => {
                routeTypeSelect.value = 'all';
                difficultyLevelSelect.value = 'all';
                maxLengthSlider.value = 150;
                maxLengthValue.textContent = '150 km';
                maxDurationSlider.value = 50;
                maxDurationValue.textContent = '50 h';
                startPointSelect.value = 'all';
                searchInput.value = '';
                criteriaCheckboxes.forEach(cb => cb.checked = false);
                filterAndDisplayRoutes(); // Re-apply to show all routes
                 // Reset POI toggles to checked and re-apply visibility
                poiToggleCheckboxes.forEach(checkbox => {
                    checkbox.checked = true;
                    if (allPOIsData) { // Ensure POI data is loaded before toggling
                         togglePOILayer(checkbox.dataset.layerGroup, true);
                    }
                });
            });

            // Search input - filter on enter or slight delay after typing
            let searchTimeout;
            searchInput.addEventListener('keyup', (event) => {
                clearTimeout(searchTimeout);
                if (event.key === 'Enter') {
                    filterAndDisplayRoutes();
                } else {
                    searchTimeout = setTimeout(filterAndDisplayRoutes, 500); // Auto-apply after 500ms
                }
            });

            // POI Toggle Checkboxes
            poiToggleCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', (event) => {
                    if (allPOIsData) { // Ensure POI data is loaded before toggling
                        togglePOILayer(event.target.dataset.layerGroup, event.target.checked);
                    } else if (event.target.checked) {
                        // If data isn't loaded yet but user checks it, make sure it loads if/when data arrives
                        // This case is mostly handled by addPOIsToMap checking current checkbox state
                        console.log(`POI layer ${event.target.dataset.layerGroup} will be shown when data loads.`);
                    }
                });
            });


            // Sidebar toggle for mobile
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.remove('translate-x-full');
                sidebar.classList.add('translate-x-0');
            });
            sidebarClose.addEventListener('click', () => {
                sidebar.classList.remove('translate-x-0');
                sidebar.classList.add('translate-x-full');
            });

            // --- Initial Data Load and Map Setup ---
            function initializeApp() {
                showLoading(true);
                // Simulate fetching route data
                // In a real app, this would be an API call: fetch('/api/routes').then(res => res.json()).then(data => { ... });
                setTimeout(() => {
                    allRoutesData = placeholderRoutes; // Use placeholder data
                    filterAndDisplayRoutes(); // Display initial set of routes (all or filtered by default)
                    // showLoading(false); // Loading will be hidden by filterAndDisplayRoutes
                }, 500); // Simulate network delay

                // Simulate fetching POI data
                // In a real app: fetch('/api/pois').then(...)
                setTimeout(() => {
                    // Define some placeholder POIs
                    allPOIsData = {
                        "type": "FeatureCollection",
                        "features": [
                            { "type": "Feature", "geometry": { "type": "Point", "coordinates": [12.587, 52.142] }, "properties": { "name": "Tourist Information Bad Belzig", "category": "amenities", "icon": "fa-info-circle", "iconColor": "#007bff", "description": "Official tourist info center." } },
                            { "type": "Feature", "geometry": { "type": "Point", "coordinates": [12.592, 52.145] }, "properties": { "name": "Hotel Burg Eisenhardt", "category": "accommodation", "icon": "fa-bed", "iconColor": "#5cb85c", "description": "Hotel located at Eisenhardt Castle." } },
                            { "type": "Feature", "geometry": { "type": "Point", "coordinates": [12.305, 52.137] }, "properties": { "name": "Wiesenburg Castle Park", "category": "amenities", "icon": "fa-tree", "iconColor": "#f0ad4e", "description": "Historic park, good for walks." } },
                            { "type": "Feature", "geometry": { "type": "Point", "coordinates": [12.433, 52.062] }, "properties": { "name": "Rabenstein Castle", "category": "amenities", "icon": "fa-chess-rook", "iconColor": "#d9534f", "description": "Medieval castle with tavern." } },
                            { "type": "Feature", "geometry": { "type": "Point", "coordinates": [12.585, 52.140] }, "properties": { "name": "SteinTherme Bad Belzig", "category": "amenities", "icon": "fa-hot-tub", "iconColor": "#5bc0de", "description": "Thermal spa and wellness center." } },
                            { "type": "Feature", "geometry": { "type": "Point", "coordinates": [12.77, 52.18] }, "properties": { "name": "Art Installation 'Der Wanderer'", "category": "amenities", "icon": "fa-palette", "iconColor": "#6f42c1", "description": "Part of the Kunstwanderweg." } }
                        ]
                    };
                    addPOIsToMap(allPOIsData);
                    // Ensure loading indicator is hidden if all data is processed
                    if (!loadingIndicator.style.display || loadingIndicator.style.display !== 'none') {
                         showLoading(false); // Hide if still visible after route loading
                    }
                }, 800); // Simulate slightly longer delay for POIs

                fetchWeather(); // Fetch weather data
            }

            initializeApp(); // Start the application
        });
    </script>
</body>
</html>

