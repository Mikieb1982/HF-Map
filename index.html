<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hoher Fl√§ming Helicopter Explorer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <style>
        :root {
            --bg-dark: #1a2332;
            --bg-medium: #2c3e50;
            --bg-light: #34495e;
            --text-primary: #ecf0f1;
            --text-secondary: #bdc3c7;
            --accent-primary: #3498db;
            --accent-secondary: #f39c12;
            --accent-success: #27ae60;
            --accent-danger: #e74c3c;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.2);
            --shadow-lg: 0 8px 16px rgba(0,0,0,0.3);
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
            width: 100%;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-medium) 100%);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            position: relative;
            user-select: none;
        }

        /* Loading Screen */
        #loading-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity var(--transition-slow);
        }

        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid var(--bg-light);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Map Container */
        #map-container {
            position: absolute;
            inset: 0;
            overflow: hidden;
            cursor: grab;
            background: radial-gradient(ellipse at center, var(--bg-light) 0%, var(--bg-dark) 100%);
        }

        #map-container:active {
            cursor: grabbing;
        }

        #map-viewport {
            position: relative;
            width: 2048px;
            height: 1448px;
            transform-origin: center center;
            will-change: transform;
        }

        #map-image {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: crisp-edges;
            opacity: 0.9;
        }

        /* Helicopter */
        #helicopter-container {
            position: absolute;
            width: 80px;
            height: 80px;
            transform-origin: center center;
            z-index: 100;
            pointer-events: none;
            will-change: transform;
        }

        #helicopter {
            position: absolute;
            inset: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 60px;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));
            animation: hover 2s ease-in-out infinite;
        }

        @keyframes hover {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        #helicopter.flying {
            animation: hover 0.5s ease-in-out infinite;
        }

        #helicopter-shadow {
            position: absolute;
            width: 60%;
            height: 20%;
            background: radial-gradient(ellipse at center, rgba(0,0,0,0.4) 0%, transparent 70%);
            top: 110%;
            left: 20%;
            filter: blur(8px);
            transform: scaleY(0.5);
        }

        /* POI Markers */
        .poi-marker {
            position: absolute;
            width: 32px;
            height: 32px;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 50;
        }

        .poi-marker-inner {
            width: 100%;
            height: 100%;
            background: var(--accent-secondary);
            border: 3px solid rgba(255,255,255,0.9);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 14px;
            color: var(--bg-dark);
            box-shadow: 0 0 20px rgba(243,156,18,0.6);
            transition: all var(--transition-normal);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(243,156,18,0.6); }
            50% { transform: scale(1.1); box-shadow: 0 0 30px rgba(243,156,18,0.8); }
        }

        .poi-marker.visited .poi-marker-inner {
            background: var(--accent-success);
            box-shadow: 0 0 20px rgba(39,174,96,0.6);
            animation: none;
        }

        .poi-marker.nearby .poi-marker-inner {
            transform: scale(1.2);
            box-shadow: 0 0 40px rgba(243,156,18,1);
        }

        /* HUD */
        #hud {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(26,35,50,0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px 20px;
            color: var(--text-primary);
            font-size: 14px;
            z-index: 200;
            box-shadow: var(--shadow-lg);
        }

        .hud-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 5px 0;
        }

        .hud-label {
            color: var(--text-secondary);
            min-width: 50px;
        }

        .hud-value {
            font-weight: 600;
            color: var(--accent-primary);
        }

        .hud-progress {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .hud-progress-bar {
            height: 100%;
            background: var(--accent-primary);
            transition: width var(--transition-fast);
        }

        /* Controls */
        #controls-container {
            position: fixed;
            bottom: 30px;
            left: 30px;
            right: 30px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            z-index: 300;
            pointer-events: none;
        }

        #joystick-area {
            width: 140px;
            height: 140px;
            position: relative;
            pointer-events: auto;
        }

        #joystick-base {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, rgba(52,73,94,0.8) 0%, rgba(26,35,50,0.9) 100%);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            box-shadow: var(--shadow-lg), inset 0 0 20px rgba(0,0,0,0.3);
        }

        #joystick-stick {
            position: absolute;
            width: 70px;
            height: 70px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle at 30% 30%, #546e7a, #37474f);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            box-shadow: var(--shadow-md);
            cursor: grab;
            touch-action: none;
            transition: none;
        }

        #joystick-stick:active {
            cursor: grabbing;
            box-shadow: var(--shadow-sm);
        }

        #action-button {
            width: 100px;
            height: 100px;
            background: var(--accent-secondary);
            border: 4px solid rgba(255,255,255,0.9);
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            color: var(--bg-dark);
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: var(--shadow-lg), 0 0 30px rgba(243,156,18,0.5);
            transition: all var(--transition-fast);
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: var(--shadow-lg), 0 0 30px rgba(243,156,18,0.5); }
            50% { box-shadow: var(--shadow-lg), 0 0 40px rgba(243,156,18,0.8); }
        }

        #action-button:active {
            transform: scale(0.95);
            box-shadow: var(--shadow-sm), 0 0 20px rgba(243,156,18,0.3);
        }

        /* Modals */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 500;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform: scale(0.9) translateY(20px);
            transition: all var(--transition-normal);
        }

        .modal.active .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal h2 {
            margin: 0 0 20px;
            color: var(--bg-dark);
            font-size: 24px;
            border-bottom: 2px solid var(--accent-primary);
            padding-bottom: 10px;
        }

        .modal p {
            line-height: 1.6;
            color: var(--bg-medium);
            margin: 15px 0;
        }

        .modal-button {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-md);
        }

        .modal-button:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .modal-button:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        /* POI List */
        #poi-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 280px;
            max-height: calc(100vh - 40px);
            background: rgba(26,35,50,0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: var(--text-primary);
            z-index: 200;
            transform: translateX(calc(100% + 40px));
            transition: transform var(--transition-normal);
            box-shadow: var(--shadow-lg);
        }

        #poi-panel.active {
            transform: translateX(0);
        }

        #poi-panel-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #poi-panel-title {
            font-size: 18px;
            font-weight: 600;
        }

        #poi-panel-close {
            width: 30px;
            height: 30px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 50%;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all var(--transition-fast);
        }

        #poi-panel-close:hover {
            background: rgba(255,255,255,0.2);
        }

        #poi-list {
            padding: 10px;
            overflow-y: auto;
            max-height: calc(100vh - 120px);
        }

        .poi-item {
            padding: 10px;
            margin: 5px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border: 1px solid transparent;
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .poi-item:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
        }

        .poi-item.visited {
            opacity: 0.6;
        }

        .poi-item.visited::after {
            content: '‚úì';
            color: var(--accent-success);
            font-weight: bold;
            float: right;
        }

        /* Menu Button */
        #menu-button {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(26,35,50,0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 201;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-md);
        }

        #menu-button:hover {
            background: rgba(52,73,94,0.9);
            transform: scale(1.05);
        }

        #menu-button:active {
            transform: scale(0.95);
        }

        /* Minimap */
        #minimap {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 200px;
            height: 150px;
            background: rgba(26,35,50,0.9);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            overflow: hidden;
            z-index: 200;
            box-shadow: var(--shadow-lg);
        }

        #minimap-canvas {
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
        }

        /* Effects */
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255,255,255,0.6);
            border-radius: 50%;
            pointer-events: none;
            animation: particle-fade 1s ease-out forwards;
        }

        @keyframes particle-fade {
            0% {
                opacity: 1;
                transform: translate(0, 0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(var(--dx), var(--dy)) scale(0);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            #hud {
                top: 10px;
                left: 10px;
                font-size: 12px;
                padding: 10px 15px;
            }

            #controls-container {
                bottom: 20px;
                left: 20px;
                right: 20px;
            }

            #joystick-area {
                width: 120px;
                height: 120px;
            }

            #action-button {
                width: 80px;
                height: 80px;
                font-size: 16px;
            }

            #minimap {
                width: 150px;
                height: 100px;
            }

            #poi-panel {
                width: 100%;
                max-width: 100%;
                top: 0;
                right: 0;
                bottom: 0;
                border-radius: 0;
            }
        }

        @media (max-height: 600px) {
            #minimap {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-spinner"></div>
        <p style="color: var(--text-primary);">Loading map...</p>
    </div>

    <!-- Map Container -->
    <div id="map-container">
        <div id="map-viewport">
            <img id="map-image" src="https://raw.githubusercontent.com/Mikieb1982/HF-Map/main/hoher_flaeming_map.jpg" alt="Hoher Fl√§ming Map">
            <div id="helicopter-container">
                <div id="helicopter">üöÅ</div>
                <div id="helicopter-shadow"></div>
            </div>
        </div>
    </div>

    <!-- HUD -->
    <div id="hud">
        <div class="hud-row">
            <span class="hud-label">Speed:</span>
            <span class="hud-value" id="speed-display">0.0</span>
            <div class="hud-progress">
                <div class="hud-progress-bar" id="speed-bar" style="width: 0%"></div>
            </div>
        </div>
        <div class="hud-row">
            <span class="hud-label">POIs:</span>
            <span class="hud-value" id="poi-count">0/16</span>
            <div class="hud-progress">
                <div class="hud-progress-bar" id="poi-bar" style="width: 0%"></div>
            </div>
        </div>
        <div class="hud-row" id="poi-indicator" style="display: none;">
            <span style="color: var(--accent-secondary);">üìç Near: <span id="nearby-poi-name"></span></span>
        </div>
    </div>

    <!-- Controls -->
    <div id="controls-container">
        <div id="joystick-area">
            <div id="joystick-base"></div>
            <div id="joystick-stick"></div>
        </div>
        <button id="action-button">Land</button>
    </div>

    <!-- Menu Button -->
    <button id="menu-button">‚ò∞</button>

    <!-- POI Panel -->
    <div id="poi-panel">
        <div id="poi-panel-header">
            <span id="poi-panel-title">Points of Interest</span>
            <button id="poi-panel-close">‚úï</button>
        </div>
        <div id="poi-list"></div>
    </div>

    <!-- Minimap -->
    <div id="minimap">
        <canvas id="minimap-canvas"></canvas>
    </div>

    <!-- Modals -->
    <div id="poi-modal" class="modal">
        <div class="modal-content">
            <h2 id="poi-modal-title">Point of Interest</h2>
            <p id="poi-modal-description"></p>
            <button class="modal-button" onclick="game.closePOIModal()">Continue Flying</button>
        </div>
    </div>

    <div id="completion-modal" class="modal">
        <div class="modal-content">
            <h2>üéâ Mission Complete!</h2>
            <p>Congratulations! You've explored all 16 points of interest in the Hoher Fl√§ming Nature Park.</p>
            <p>Your journey took you through historic castles, natural landmarks, and charming villages.</p>
            <button class="modal-button" onclick="game.restart()">Fly Again</button>
        </div>
    </div>

    <script>
    // Game Engine
    class HelicopterGame {
        constructor() {
            this.config = {
                MAP_WIDTH: 2048,
                MAP_HEIGHT: 1448,
                START_X: 1364,
                START_Y: 603,
                MAX_SPEED: 6,
                ACCELERATION: 0.2,
                DECELERATION: 0.95,
                TURN_SPEED: 4,
                LANDING_RADIUS: 80,
                PARTICLE_COUNT: 3
            };

            this.state = {
                helicopter: {
                    x: this.config.START_X,
                    y: this.config.START_Y,
                    vx: 0,
                    vy: 0,
                    angle: -90,
                    speed: 0,
                    targetAngle: -90
                },
                input: {
                    thrust: 0,
                    turning: 0,
                    keys: new Set()
                },
                joystick: {
                    active: false,
                    touchId: null,
                    centerX: 0,
                    centerY: 0
                },
                pois: this.initializePOIs(),
                nearbyPOI: null,
                gameState: 'loading',
                visitedCount: 0
            };

            this.audio = {
                initialized: false,
                engine: null,
                effects: null
            };

            this.dom = this.cacheDOMElements();
            this.minimap = {
                canvas: null,
                ctx: null,
                scale: 0.08
            };

            this.init();
        }

        initializePOIs() {
            return [
                { id: 1, name: "Stadt und Burg Ziesar", x: 470, y: 150, description: "Burg Ziesar is one of Brandenburg's few preserved bishop's residences. This lowland castle features a museum showcasing medieval church and cultural history." },
                { id: 2, name: "Gutspark Dahlen", x: 708, y: 357, description: "Gutspark Dahlen is a dendrologically significant park in Hoher Fl√§ming, designed in the English style since 1840. It offers historic vistas and impressive blossoms." },
                { id: 3, name: "Klein Briesener Bach", x: 998, y: 181, description: "The Klein Briesener Bach is a small stream originating near Gro√ü Briesen, part of several protected areas within the Hoher Fl√§ming Nature Park." },
                { id: 4, name: "Paradies Dippmannsdorf", x: 1322, y: 265, description: "A nearby nature reserve, also called 'Das Paradies', features a headwater with over 30 springs, perfect for a walk." },
                { id: 5, name: "T√∂pferort G√∂rzke", x: 416, y: 439, description: "G√∂rzke is a traditional pottery village. Visitors can explore local potteries and visit the Crafts Museum." },
                { id: 6, name: "Hagelberg", x: 946, y: 719, description: "Hagelberg is known for the Battle of Hagelberg in 1813, a significant event during the Napoleonic Wars. A monument commemorates this historical site." },
                { id: 7, name: "Bad Belzig mit Burg Eisenhardt", x: 1364, y: 603, description: "Bad Belzig is home to Burg Eisenhardt, a historic castle. Its tower, the 'Butterturm', offers panoramic views." },
                { id: 8, name: "Aussichtspunkt Belziger Landschaftswiesen", x: 1616, y: 501, description: "This viewpoint offers impressive views of the Belziger Landschaftswiesen, an important bird sanctuary and crucial habitat for great bustards." },
                { id: 9, name: "Wiesenburg mit Schloss und Park", x: 836, y: 843, description: "Wiesenburg features a picturesque castle and one of the most dendrologically significant parks in the region, designed in the English style." },
                { id: 10, name: "Naturparkzentrum Hoher Fl√§ming", x: 1170, y: 1231, description: "The Hoher Fl√§ming Nature Park Center in Raben is the main information hub for visitors, offering details on hiking routes and events." },
                { id: 11, name: "Raben mit Burg Rabenstein", x: 1124, y: 1329, description: "Burg Rabenstein is arguably the most important castle in Hoher Fl√§ming, serving historically as a border castle between Brandenburg and Saxony." },
                { id: 12, name: "Niemegk", x: 1624, y: 1135, description: "Niemegk is a historic town in the Hoher Fl√§ming region, part of an initiative providing information on local culture and products." },
                { id: 13, name: "Fl√§mingbuchen", x: 654, y: 1171, description: "The Fl√§mingbuchen are unique beech tree islands within the Brandtsheide forest, known for their lush blueberry patches." },
                { id: 14, name: "Brautrummel mit Riesenstein", x: 1110, y: 1023, description: "The Brautrummel is a periglacial dry valley and natural monument, featuring a scenic circular hiking trail leading to the 'Riesenstein' (Giant Stone)." },
                { id: 15, name: "Neuendorfer Rummel", x: 1482, y: 1309, description: "The Neuendorfer Rummel is one of the deep, narrow dry valleys (Rummeln) formed by the Ice Age, offering a unique hiking experience." },
                { id: 16, name: "Garrey mit Aussichtsplattform", x: 1494, y: 1427, description: "Garrey features an observation deck at the former 'Altes Wasserwerk' (old waterworks) with a small petting zoo and scenic views." }
            ].map(poi => ({ ...poi, visited: false }));
        }

        cacheDOMElements() {
            return {
                loadingScreen: document.getElementById('loading-screen'),
                mapContainer: document.getElementById('map-container'),
                mapViewport: document.getElementById('map-viewport'),
                mapImage: document.getElementById('map-image'),
                helicopterContainer: document.getElementById('helicopter-container'),
                helicopter: document.getElementById('helicopter'),
                speedDisplay: document.getElementById('speed-display'),
                speedBar: document.getElementById('speed-bar'),
                poiCount: document.getElementById('poi-count'),
                poiBar: document.getElementById('poi-bar'),
                poiIndicator: document.getElementById('poi-indicator'),
                nearbyPOIName: document.getElementById('nearby-poi-name'),
                joystickStick: document.getElementById('joystick-stick'),
                joystickArea: document.getElementById('joystick-area'),
                actionButton: document.getElementById('action-button'),
                menuButton: document.getElementById('menu-button'),
                poiPanel: document.getElementById('poi-panel'),
                poiPanelClose: document.getElementById('poi-panel-close'),
                poiList: document.getElementById('poi-list'),
                poiModal: document.getElementById('poi-modal'),
                poiModalTitle: document.getElementById('poi-modal-title'),
                poiModalDescription: document.getElementById('poi-modal-description'),
                completionModal: document.getElementById('completion-modal'),
                minimapCanvas: document.getElementById('minimap-canvas')
            };
        }

        init() {
            this.setupEventListeners();
            this.setupMinimap();
            this.createPOIMarkers();
            this.populatePOIList();

            this.dom.mapImage.onload = () => {
                this.dom.loadingScreen.classList.add('hidden');
                this.state.gameState = 'flying';
                this.centerCamera();
                this.gameLoop();
            };

            this.dom.mapImage.onerror = () => {
                this.dom.loadingScreen.innerHTML = '<p style="color: var(--accent-danger);">Failed to load map. Please refresh.</p>';
            };
        }

        setupEventListeners() {
            // Keyboard