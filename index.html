<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hoher Fl√§ming Helicopter Explorer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <style>
        /* Reset and Variables */
        :root {
            --bg-dark: #1a2332;
            --bg-medium: #2c3e50;
            --bg-light: #34495e;
            --text-primary: #ecf0f1;
            --text-secondary: #bdc3c7;
            --accent-primary: #3498db;
            --accent-secondary: #f39c12;
            --accent-success: #27ae60;
            --accent-danger: #e74c3c;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.2);
            --shadow-lg: 0 8px 16px rgba(0,0,0,0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-medium) 100%);
            position: relative;
        }

        /* Loading Screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: var(--text-primary);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid var(--bg-light);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Map Container */
        #map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: scroll;
            cursor: grab;
            background: var(--bg-medium);
            -webkit-overflow-scrolling: touch;
        }

        #map-container:active {
            cursor: grabbing;
        }

        #map-content {
            position: relative;
            width: 2048px;
            height: 1448px;
        }

        #map-image {
            display: block;
            width: 100%;
            height: 100%;
            opacity: 0.9;
        }

        /* Helicopter */
        #helicopter-container {
            position: absolute;
            width: 80px;
            height: 80px;
            transform-origin: center center;
            z-index: 100;
            pointer-events: none;
            transition: none;
        }

        #helicopter {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 60px;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5));
            animation: hover 2s ease-in-out infinite;
        }

        @keyframes hover {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        #helicopter-shadow {
            position: absolute;
            width: 60%;
            height: 20%;
            background: radial-gradient(ellipse at center, rgba(0,0,0,0.4) 0%, transparent 70%);
            top: 110%;
            left: 20%;
            filter: blur(8px);
        }

        /* POI Markers */
        .poi-marker {
            position: absolute;
            width: 32px;
            height: 32px;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 50;
        }

        .poi-marker-inner {
            width: 100%;
            height: 100%;
            background: var(--accent-secondary);
            border: 3px solid rgba(255,255,255,0.9);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 14px;
            color: var(--bg-dark);
            box-shadow: 0 0 20px rgba(243,156,18,0.6);
            transition: all 0.3s ease;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 0 20px rgba(243,156,18,0.6); 
            }
            50% { 
                transform: scale(1.1); 
                box-shadow: 0 0 30px rgba(243,156,18,0.8); 
            }
        }

        .poi-marker.visited .poi-marker-inner {
            background: var(--accent-success);
            box-shadow: 0 0 20px rgba(39,174,96,0.6);
            animation: none;
        }

        .poi-marker.nearby .poi-marker-inner {
            transform: scale(1.2);
            box-shadow: 0 0 40px rgba(243,156,18,1);
        }

        /* HUD */
        #hud {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(26,35,50,0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px 20px;
            color: var(--text-primary);
            font-size: 14px;
            z-index: 200;
            box-shadow: var(--shadow-lg);
            pointer-events: none;
        }

        .hud-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }

        .hud-label {
            color: var(--text-secondary);
            min-width: 50px;
        }

        .hud-value {
            font-weight: 600;
            color: var(--accent-primary);
        }

        #land-prompt {
            color: var(--accent-secondary);
            font-weight: bold;
            margin-top: 10px;
            display: none;
        }

        /* Controls */
        #joystick-container {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 140px;
            height: 140px;
            z-index: 300;
        }

        #joystick-base {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(52,73,94,0.8) 0%, rgba(26,35,50,0.9) 100%);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            box-shadow: var(--shadow-lg), inset 0 0 20px rgba(0,0,0,0.3);
        }

        #joystick-handle {
            position: absolute;
            width: 70px;
            height: 70px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: radial-gradient(circle at 30% 30%, #546e7a, #37474f);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            box-shadow: var(--shadow-md);
            cursor: grab;
            touch-action: none;
        }

        #land-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 100px;
            height: 100px;
            background: var(--accent-secondary);
            border: 4px solid rgba(255,255,255,0.9);
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            color: var(--bg-dark);
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: var(--shadow-lg), 0 0 30px rgba(243,156,18,0.5);
            transition: all 0.2s ease;
            z-index: 301;
        }

        #land-button:active {
            transform: scale(0.95);
        }

        /* Menu Button */
        #menu-button {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(26,35,50,0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 201;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-md);
        }

        #menu-button:hover {
            background: rgba(52,73,94,0.9);
        }

        /* POI Panel */
        #poi-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 280px;
            max-height: calc(100vh - 100px);
            background: rgba(26,35,50,0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: var(--text-primary);
            z-index: 200;
            transform: translateX(calc(100% + 40px));
            transition: transform 0.3s ease;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        #poi-panel.active {
            transform: translateX(0);
        }

        #poi-panel-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 18px;
            font-weight: 600;
        }

        #poi-list {
            padding: 10px;
            overflow-y: auto;
            max-height: calc(100vh - 180px);
        }

        .poi-item {
            padding: 10px;
            margin: 5px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            cursor: pointer;
            font-size: 14px;
        }

        .poi-item:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
        }

        .poi-item.visited {
            opacity: 0.6;
            text-decoration: line-through;
        }

        .poi-item.visited::after {
            content: ' ‚úì';
            color: var(--accent-success);
            font-weight: bold;
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 500;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
        }

        .modal.active .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal h2 {
            margin: 0 0 20px;
            color: var(--bg-dark);
            font-size: 24px;
            border-bottom: 2px solid var(--accent-primary);
            padding-bottom: 10px;
        }

        .modal p {
            line-height: 1.6;
            color: var(--bg-medium);
            margin: 15px 0;
        }

        .modal-button {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-md);
        }

        .modal-button:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Responsive */
        @media (max-width: 768px) {
            #hud {
                top: 10px;
                left: 10px;
                font-size: 12px;
                padding: 10px 15px;
            }

            #joystick-container {
                bottom: 20px;
                left: 20px;
                width: 120px;
                height: 120px;
            }

            #land-button {
                bottom: 20px;
                right: 20px;
                width: 80px;
                height: 80px;
                font-size: 16px;
            }

            #keyboard-info {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-spinner"></div>
        <p>Loading Hoher Fl√§ming map...</p>
    </div>

    <!-- Map Container -->
    <div id="map-container">
        <div id="map-content">
            <img id="map-image" src="https://raw.githubusercontent.com/Mikieb1982/HF-Map/main/hoher_flaeming_map.jpg" alt="Hoher Fl√§ming Map">
            <div id="helicopter-container">
                <div id="helicopter">üöÅ</div>
                <div id="helicopter-shadow"></div>
            </div>
        </div>
    </div>

    <!-- HUD -->
    <div id="hud">
        <div class="hud-row" id="keyboard-info">
            <span style="color: var(--text-secondary);">Keys: Arrows/WASD ‚Ä¢ L to land</span>
        </div>
        <div class="hud-row">
            <span class="hud-label">Speed:</span>
            <span class="hud-value" id="speed-display">0.0</span>
        </div>
        <div class="hud-row">
            <span class="hud-label">POIs:</span>
            <span class="hud-value" id="poi-count">0/16</span>
        </div>
        <div id="land-prompt">üìç Ready to land!</div>
    </div>

    <!-- Controls -->
    <div id="joystick-container">
        <div id="joystick-base"></div>
        <div id="joystick-handle"></div>
    </div>
    <button id="land-button">Land</button>

    <!-- Menu -->
    <button id="menu-button">‚ò∞</button>
    <div id="poi-panel">
        <div id="poi-panel-header">Points of Interest</div>
        <div id="poi-list"></div>
    </div>

    <!-- Modals -->
    <div id="poi-modal" class="modal">
        <div class="modal-content">
            <h2 id="poi-modal-title">Point of Interest</h2>
            <p id="poi-modal-description"></p>
            <button class="modal-button" id="continue-button">Continue Flying</button>
        </div>
    </div>

    <div id="completion-modal" class="modal">
        <div class="modal-content">
            <h2>üéâ Mission Complete!</h2>
            <p>Congratulations! You've explored all 16 points of interest in the Hoher Fl√§ming Nature Park.</p>
            <button class="modal-button" id="restart-button">Fly Again</button>
        </div>
    </div>

    <script>
    // Game implementation
    (function() {
        'use strict';

        // Configuration
        const CONFIG = {
            MAP_WIDTH: 2048,
            MAP_HEIGHT: 1448,
            START_X: 1364,
            START_Y: 603,
            MAX_SPEED: 6,
            ACCELERATION: 0.15,
            DRAG: 0.98,
            TURN_SPEED: 3,
            LANDING_RADIUS: 80,
            JOYSTICK_RADIUS: 50
        };

        // POI Data
        const POI_DATA = [
            { id: 1, name: "Stadt und Burg Ziesar", x: 470, y: 150, description: "Burg Ziesar is one of Brandenburg's few preserved bishop's residences." },
            { id: 2, name: "Gutspark Dahlen", x: 708, y: 357, description: "A dendrologically significant park designed in the English style since 1840." },
            { id: 3, name: "Klein Briesener Bach", x: 998, y: 181, description: "A small stream originating near Gro√ü Briesen." },
            { id: 4, name: "Paradies Dippmannsdorf", x: 1322, y: 265, description: "A nature reserve with over 30 springs." },
            { id: 5, name: "T√∂pferort G√∂rzke", x: 416, y: 439, description: "A traditional pottery village with local potteries and a Crafts Museum." },
            { id: 6, name: "Hagelberg", x: 946, y: 719, description: "Site of the Battle of Hagelberg in 1813 during the Napoleonic Wars." },
            { id: 7, name: "Bad Belzig mit Burg Eisenhardt", x: 1364, y: 603, description: "Home to Burg Eisenhardt with its 'Butterturm' offering panoramic views." },
            { id: 8, name: "Aussichtspunkt Belziger Landschaftswiesen", x: 1616, y: 501, description: "Viewpoint of an important bird sanctuary and great bustard habitat." },
            { id: 9, name: "Wiesenburg mit Schloss und Park", x: 836, y: 843, description: "Features a picturesque castle and significant English-style park." },
            { id: 10, name: "Naturparkzentrum Hoher Fl√§ming", x: 1170, y: 1231, description: "The main information hub for the Nature Park in Raben." },
            { id: 11, name: "Raben mit Burg Rabenstein", x: 1124, y: 1329, description: "The most important castle in Hoher Fl√§ming, a historic border castle." },
            { id: 12, name: "Niemegk", x: 1624, y: 1135, description: "A historic town providing information on local culture and products." },
            { id: 13, name: "Fl√§mingbuchen", x: 654, y: 1171, description: "Unique beech tree islands within the Brandtsheide forest." },
            { id: 14, name: "Brautrummel mit Riesenstein", x: 1110, y: 1023, description: "A periglacial dry valley with the 'Riesenstein' (Giant Stone)." },
            { id: 15, name: "Neuendorfer Rummel", x: 1482, y: 1309, description: "A deep, narrow dry valley formed by the Ice Age." },
            { id: 16, name: "Garrey mit Aussichtsplattform", x: 1494, y: 1427, description: "Features an observation deck at the former waterworks." }
        ];

        // Game state
        const state = {
            helicopter: {
                x: CONFIG.START_X,
                y: CONFIG.START_Y,
                vx: 0,
                vy: 0,
                angle: -90,
                speed: 0
            },
            input: {
                keys: new Set(),
                joystick: {
                    active: false,
                    angle: 0,
                    magnitude: 0
                }
            },
            pois: POI_DATA.map(p => ({ ...p, visited: false })),
            nearbyPOI: null,
            visitedCount: 0,
            gameActive: false
        };

        // DOM elements
        const dom = {
            loadingScreen: document.getElementById('loading-screen'),
            mapContainer: document.getElementById('map-container'),
            mapContent: document.getElementById('map-content'),
            mapImage: document.getElementById('map-image'),
            helicopterContainer: document.getElementById('helicopter-container'),
            speedDisplay: document.getElementById('speed-display'),
            poiCount: document.getElementById('poi-count'),
            landPrompt: document.getElementById('land-prompt'),
            joystickContainer: document.getElementById('joystick-container'),
            joystickHandle: document.getElementById('joystick-handle'),
            landButton: document.getElementById('land-button'),
            menuButton: document.getElementById('menu-button'),
            poiPanel: document.getElementById('poi-panel'),
            poiList: document.getElementById('poi-list'),
            poiModal: document.getElementById('poi-modal'),
            poiModalTitle: document.getElementById('poi-modal-title'),
            poiModalDescription: document.getElementById('poi-modal-description'),
            continueButton: document.getElementById('continue-button'),
            completionModal: document.getElementById('completion-modal'),
            restartButton: document.getElementById('restart-button')
        };

        // Audio
        let audioInitialized = false;
        let engineSound = null;

        function initAudio() {
            if (audioInitialized) return;
            Tone.start().then(() => {
                engineSound = new Tone.Noise("brown").toDestination();
                engineSound.volume.value = -35;
                engineSound.start();
                audioInitialized = true;
            });
        }

        // Initialize
        function init() {
            createPOIMarkers();
            populatePOIList();
            setupEventListeners();

            // Handle map load
            if (dom.mapImage.complete) {
                onMapLoaded();
            } else {
                dom.mapImage.addEventListener('load', onMapLoaded);
                dom.mapImage.addEventListener('error', onMapError);
            }
        }

        function onMapLoaded() {
            dom.loadingScreen.style.display = 'none';
            state.gameActive = true;
            centerCamera();
            requestAnimationFrame(gameLoop);
        }

        function onMapError() {
            dom.loadingScreen.innerHTML = '<p style="color: var(--accent-danger);">Failed to load map. Please refresh the page.</p>';
        }

        function createPOIMarkers() {
            state.pois.forEach(poi => {
                const marker = document.createElement('div');
                marker.className = 'poi-marker';
                marker.id = `poi-${poi.id}`;
                marker.style.left = `${poi.x}px`;
                marker.style.top = `${poi.y}px`;
                
                const inner = document.createElement('div');
                inner.className = 'poi-marker-inner';
                inner.textContent = poi.id;
                marker.appendChild(inner);
                
                dom.mapContent.appendChild(marker);
            });
        }

        function populatePOIList() {
            dom.poiList.innerHTML = '';
            state.pois.forEach(poi => {
                const item = document.createElement('div');
                item.className = 'poi-item';
                item.id = `poi-list-${poi.id}`;
                item.textContent = `${poi.id}. ${poi.name}`;
                dom.poiList.appendChild(item);
            });
        }

        function setupEventListeners() {
            // Keyboard
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);

            // Joystick
            dom.joystickContainer.addEventListener('touchstart', handleJoystickStart, { passive: false });
            document.addEventListener('touchmove', handleJoystickMove, { passive: false });
            document.addEventListener('touchend', handleJoystickEnd, { passive: false });

            // Mouse for joystick (desktop)
            dom.joystickContainer.addEventListener('mousedown', handleJoystickMouseStart);
            document.addEventListener('mousemove', handleJoystickMouseMove);
            document.addEventListener('mouseup', handleJoystickMouseEnd);

            // Buttons
            dom.landButton.addEventListener('click', landAtPOI);
            dom.menuButton.addEventListener('click', togglePOIPanel);
            dom.continueButton.addEventListener('click', resumeFlight);
            dom.restartButton.addEventListener('click', restartGame);
        }

        // Input handling
        function handleKeyDown(e) {
            if (!state.gameActive) return;
            initAudio();
            
            state.input.keys.add(e.key.toLowerCase());
            
            if ((e.key === 'l' || e.key === 'L') && state.nearbyPOI) {
                landAtPOI();
            }
        }

        function handleKeyUp(e) {
            state.input.keys.delete(e.key.toLowerCase());
        }

        let joystickTouch = null;
        function handleJoystickStart(e) {
            if (!state.gameActive) return;
            initAudio();
            
            e.preventDefault();
            const touch = e.touches[0];
            joystickTouch = touch.identifier;
            state.input.joystick.active = true;
            updateJoystick(touch.clientX, touch.clientY);
        }

        function handleJoystickMove(e) {
            if (!state.input.joystick.active) return;
            
            for (let touch of e.touches) {
                if (touch.identifier === joystickTouch) {
                    e.preventDefault();
                    updateJoystick(touch.clientX, touch.clientY);
                    break;
                }
            }
        }

        function handleJoystickEnd(e) {
            for (let touch of e.changedTouches) {
                if (touch.identifier === joystickTouch) {
                    e.preventDefault();
                    resetJoystick();
                    break;
                }
            }
        }

        let mouseJoystick = false;
        function handleJoystickMouseStart(e) {
            if (!state.gameActive) return;
            initAudio();
            
            mouseJoystick = true;
            state.input.joystick.active = true;
            updateJoystick(e.clientX, e.clientY);
        }

        function handleJoystickMouseMove(e) {
            if (!mouseJoystick) return;
            updateJoystick(e.clientX, e.clientY);
        }

        function handleJoystickMouseEnd() {
            if (!mouseJoystick) return;
            mouseJoystick = false;
            resetJoystick();
        }

        function updateJoystick(clientX, clientY) {
            const rect = dom.joystickContainer.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            let dx = clientX - centerX;
            let dy = clientY - centerY;
            let distance = Math.sqrt(dx * dx + dy * dy);
            
            if (distance > CONFIG.JOYSTICK_RADIUS) {
                dx = (dx / distance) * CONFIG.JOYSTICK_RADIUS;
                dy = (dy / distance) * CONFIG.JOYSTICK_RADIUS;
                distance = CONFIG.JOYSTICK_RADIUS;
            }
            
            state.input.joystick.angle = Math.atan2(dy, dx);
            state.input.joystick.magnitude = distance / CONFIG.JOYSTICK_RADIUS;
            
            dom.joystickHandle.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
        }

        function resetJoystick() {
            state.input.joystick.active = false;
            state.input.joystick.magnitude = 0;
            joystickTouch = null;
            dom.joystickHandle.style.transform = 'translate(-50%, -50%)';
        }

        // Game loop
        let lastTime = 0;
        function gameLoop(currentTime) {
            const deltaTime = Math.min((currentTime - lastTime) / 16.67, 2);
            lastTime = currentTime;
            
            if (state.gameActive) {
                update(deltaTime);
                render();
            }
            
            requestAnimationFrame(gameLoop);
        }

        function update(dt) {
            const heli = state.helicopter;
            
            // Handle input
            let thrust = 0;
            let turning = 0;
            
            // Keyboard
            if (state.input.keys.has('arrowup') || state.input.keys.has('w')) thrust = 1;
            if (state.input.keys.has('arrowdown') || state.input.keys.has('s')) thrust = -0.5;
            if (state.input.keys.has('arrowleft') || state.input.keys.has('a')) turning = -1;
            if (state.input.keys.has('arrowright') || state.input.keys.has('d')) turning = 1;
            
            // Joystick overrides keyboard
            if (state.input.joystick.active) {
                thrust = state.input.joystick.magnitude;
                const targetAngle = state.input.joystick.angle * 180 / Math.PI;
                let angleDiff = targetAngle - heli.angle;
                while (angleDiff > 180) angleDiff -= 360;
                while (angleDiff < -180) angleDiff += 360;
                turning = Math.max(-1, Math.min(1, angleDiff / 45));
            }
            
            // Update angle
            heli.angle += turning * CONFIG.TURN_SPEED * dt;
            
            // Update velocity
            const angleRad = heli.angle * Math.PI / 180;
            const accel = thrust * CONFIG.ACCELERATION;
            heli.vx += Math.cos(angleRad) * accel * dt;
            heli.vy += Math.sin(angleRad) * accel * dt;
            
            // Apply drag
            const drag = state.nearbyPOI ? 0.9 : CONFIG.DRAG;
            heli.vx *= Math.pow(drag, dt);
            heli.vy *= Math.pow(drag, dt);
            
            // Calculate speed
            heli.speed = Math.sqrt(heli.vx * heli.vx + heli.vy * heli.vy);
            
            // Limit speed
            if (heli.speed > CONFIG.MAX_SPEED) {
                const scale = CONFIG.MAX_SPEED / heli.speed;
                heli.vx *= scale;
                heli.vy *= scale;
                heli.speed = CONFIG.MAX_SPEED;
            }
            
            // Update position
            heli.x += heli.vx * dt;
            heli.y += heli.vy * dt;
            
            // Keep in bounds
            heli.x = Math.max(40, Math.min(CONFIG.MAP_WIDTH - 40, heli.x));
            heli.y = Math.max(40, Math.min(CONFIG.MAP_HEIGHT - 40, heli.y));
            
            // Check POI proximity
            checkPOIProximity();
            
            // Update audio
            if (audioInitialized && engineSound) {
                const volume = -35 + (heli.speed / CONFIG.MAX_SPEED) * 15;
                engineSound.volume.rampTo(volume, 0.1);
            }
        }

        function checkPOIProximity() {
            let nearestPOI = null;
            let minDistance = Infinity;
            
            for (const poi of state.pois) {
                if (poi.visited) continue;
                
                const dx = state.helicopter.x - poi.x;
                const dy = state.helicopter.y - poi.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < CONFIG.LANDING_RADIUS && distance < minDistance) {
                    nearestPOI = poi;
                    minDistance = distance;
                }
            }
            
            if (nearestPOI !== state.nearbyPOI) {
                // Clear previous nearby marker
                if (state.nearbyPOI) {
                    document.getElementById(`poi-${state.nearbyPOI.id}`).classList.remove('nearby');
                }
                
                state.nearbyPOI = nearestPOI;
                
                if (nearestPOI) {
                    // Show landing UI
                    document.getElementById(`poi-${nearestPOI.id}`).classList.add('nearby');
                    dom.landPrompt.style.display = 'block';
                    dom.landButton.style.display = 'flex';
                } else {
                    // Hide landing UI
                    dom.landPrompt.style.display = 'none';
                    dom.landButton.style.display = 'none';
                }
            }
        }

        function render() {
            // Update helicopter position
            dom.helicopterContainer.style.left = `${state.helicopter.x}px`;
            dom.helicopterContainer.style.top = `${state.helicopter.y}px`;
            
            const visualAngle = state.helicopter.angle + 90;
            dom.helicopterContainer.style.transform = `translate(-50%, -50%) rotate(${visualAngle}deg)`;
            
            // Update HUD
            dom.speedDisplay.textContent = state.helicopter.speed.toFixed(1);
            dom.poiCount.textContent = `${state.visitedCount}/16`;
            
            // Center camera
            centerCamera();
        }

        function centerCamera() {
            const scrollX = state.helicopter.x - dom.mapContainer.clientWidth / 2;
            const scrollY = state.helicopter.y - dom.mapContainer.clientHeight / 2;
            dom.mapContainer.scrollTo(scrollX, scrollY);
        }

        // Game actions
        function landAtPOI() {
            if (!state.nearbyPOI || !state.gameActive) return;
            
            state.gameActive = false;
            
            // Stop helicopter
            state.helicopter.vx = 0;
            state.helicopter.vy = 0;
            state.input.joystick.magnitude = 0;
            
            // Mark as visited
            const poi = state.nearbyPOI;
            poi.visited = true;
            state.visitedCount++;
            
            document.getElementById(`poi-${poi.id}`).classList.add('visited');
            document.getElementById(`poi-list-${poi.id}`).classList.add('visited');
            
            // Hide landing UI
            dom.landPrompt.style.display = 'none';
            dom.landButton.style.display = 'none';
            
            // Show POI info
            dom.poiModalTitle.textContent = `${poi.id}. ${poi.name}`;
            dom.poiModalDescription.textContent = poi.description;
            dom.poiModal.classList.add('active');
            
            // Check completion
            if (state.visitedCount === 16) {
                setTimeout(() => {
                    dom.poiModal.classList.remove('active');
                    dom.completionModal.classList.add('active');
                }, 2000);
            }
        }

        function resumeFlight() {
            dom.poiModal.classList.remove('active');
            state.gameActive = true;
            state.nearbyPOI = null;
            document.querySelectorAll('.poi-marker.nearby').forEach(m => m.classList.remove('nearby'));
        }

        function togglePOIPanel() {
            dom.poiPanel.classList.toggle('active');
        }

        function restartGame() {
            // Reset state
            state.helicopter.x = CONFIG.START_X;
            state.helicopter.y = CONFIG.START_Y;
            state.helicopter.vx = 0;
            state.helicopter.vy = 0;
            state.helicopter.angle = -90;
            state.helicopter.speed = 0;
            state.visitedCount = 0;
            state.nearbyPOI = null;
            state.gameActive = true;
            
            // Reset POIs
            state.pois.forEach(poi => {
                poi.visited = false;
                document.getElementById(`poi-${poi.id}`).classList.remove('visited', 'nearby');
                document.getElementById(`poi-list-${poi.id}`).classList.remove('visited');
            });
            
            // Hide modals
            dom.completionModal.classList.remove('active');
            dom.landPrompt.style.display = 'none';
            dom.landButton.style.display = 'none';
            
            // Reset joystick
            resetJoystick();
            
            // Center camera
            centerCamera();
        }

        // Start the game
        init();
    })();
    </script>
</body>
</html>